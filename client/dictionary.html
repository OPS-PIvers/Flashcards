<script>
  /**
   * Dictionary integration UI functionality (Admin Panel Tab)
   */
  
  function initDictionaryLookup() {
    const lookupBtn = document.getElementById('lookupWordBtn');
    if (lookupBtn) lookupBtn.addEventListener('click', lookupWordInDictionaryTab);
    
    const wordInput = document.getElementById('dictionaryWord');
    if (wordInput) wordInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') lookupWordInDictionaryTab(); });
    
    populateDeckDropdownForDictionary();
    
    const deckDropdown = document.getElementById('targetDeck');
    if (deckDropdown) deckDropdown.addEventListener('change', loadCardsForDeckInDictionary);
    
    const addToDeckBtn = document.getElementById('addToDeckBtn');
    if (addToDeckBtn) addToDeckBtn.addEventListener('click', addMultimediaContentToSelectedCard);

    // Clear previous results if any
    const resultsArea = document.getElementById('dictionaryResults');
    if (resultsArea) resultsArea.style.display = 'none';
    window.currentDictionaryWordData = null; // Store full result for adding to card
  }
  
  function lookupWordInDictionaryTab() {
    const wordInput = document.getElementById('dictionaryWord');
    const word = wordInput.value.trim();
    
    if (!word) {
      showError('Please enter a word to look up');
      return;
    }
    
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(displayMultimediaResultsInDictionaryTab)
      .withFailureHandler(function(err) {
          hideLoadingIndicator();
          handleError(err); // handleError is in main.html
          const resultsArea = document.getElementById('dictionaryResults');
          if(resultsArea) resultsArea.style.display = 'none'; // Hide results on error
      })
      .previewDictionaryContent(word); // Server-side function name is still previewDictionaryContent
  }
  
  function displayMultimediaResultsInDictionaryTab(result) {
    hideLoadingIndicator();
    window.currentDictionaryWordData = result; // Store the whole result object
    
    const resultsArea = document.getElementById('dictionaryResults');
    if (!resultsArea) { console.error("Dictionary results area not found"); return; }

    if (!result || (!result.success && !result.audioUrl && !result.imageUrl)) { // Show error if completely failed
      showError(result.message || 'Failed to fetch content.');
      resultsArea.style.display = 'none';
      return;
    }
    
    resultsArea.style.display = 'block';
    document.getElementById('resultWord').textContent = result.word || 'Word lookup';
    
    const pronunciationArea = document.getElementById('pronunciationResult');
    if (result.audioUrl) {
      pronunciationArea.innerHTML = `
        <audio controls style="width:100%;">
          <source src="${result.audioUrl}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>`;
    } else {
      pronunciationArea.innerHTML = `<p>No pronunciation audio available. ${result.message.includes("Audio:") ? result.message.split("Audio:")[1].split(";")[0].trim() : ''}</p>`;
    }
    
    const illustrationArea = document.getElementById('illustrationResult');
    if (result.imageUrl) {
      illustrationArea.innerHTML = `
        <img src="${result.imageUrl}" alt="Illustration of ${escapeHtml(result.word)}" style="max-width: 100%; height: auto; border-radius: 4px; border: 1px solid #eee;">`;
    } else {
      illustrationArea.innerHTML = `<p>No illustration available. ${result.message.includes("Image:") ? result.message.split("Image:")[1].split(";")[0].trim() : ''}</p>`;
    }
    if (result.message && result.message.toLowerCase().includes("partial success")) {
        showSuccess(result.message); // Show partial success as a non-blocking notification
    } else if (result.success) {
        showSuccess("Content fetched successfully.");
    }
  }
  
  function populateDeckDropdownForDictionary() {
    // showLoadingIndicator(); // Might be too much if other loaders are active
    google.script.run
      .withSuccessHandler(function(result) {
        // hideLoadingIndicator();
        if (!result.success) {
          showError(result.message);
          return;
        }
        const deckDropdown = document.getElementById('targetDeck');
        if (!deckDropdown) { console.error("Target deck dropdown not found"); return; }
        deckDropdown.innerHTML = '<option value="">Select a deck...</option>';
        const systemSheets = ['Config', 'Classes'];
        const userDecks = result.decks.filter(deckName => !systemSheets.includes(deckName));
        userDecks.forEach(deckName => {
          const option = document.createElement('option');
          option.value = deckName;
          option.textContent = deckName;
          deckDropdown.appendChild(option);
        });
      })
      .withFailureHandler(handleError)
      .getAvailableDecks(false); // Get all, including system, then filter
  }
  
  function loadCardsForDeckInDictionary() {
    const deckDropdown = document.getElementById('targetDeck');
    const cardSelectionArea = document.getElementById('cardSelectionArea');
    const targetCardDropdown = document.getElementById('targetCard');

    if (!deckDropdown || !cardSelectionArea || !targetCardDropdown) {
        console.error("Dictionary tab's deck/card selection elements not found.");
        return;
    }

    const selectedDeck = deckDropdown.value;
    if (!selectedDeck) {
      cardSelectionArea.style.display = 'none';
      return;
    }
    
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        if (!result.success) {
          showError(result.message);
          cardSelectionArea.style.display = 'none';
          return;
        }
        targetCardDropdown.innerHTML = '<option value="">Select a card...</option>';
        if (result.cards && result.cards.length > 0) {
            result.cards.forEach(card => {
              const option = document.createElement('option');
              option.value = card.id || card.FlashcardID; // Use 'id' if present, fallback to 'FlashcardID'
              option.textContent = `${card.sideA || card.FlashcardSideA} (ID: ${option.value})`;
              targetCardDropdown.appendChild(option);
            });
            cardSelectionArea.style.display = 'block';
        } else {
            targetCardDropdown.innerHTML = '<option value="">No cards in this deck</option>';
            cardSelectionArea.style.display = 'block'; // Show area but with "no cards"
        }
      })
      .withFailureHandler(function(err){
          hideLoadingIndicator();
          handleError(err);
          cardSelectionArea.style.display = 'none';
      })
      .getFlashcardsForDeck(selectedDeck); // This returns cards with 'id', 'sideA' etc.
  }
  
  function addMultimediaContentToSelectedCard() {
    const deckDropdown = document.getElementById('targetDeck');
    const cardDropdown = document.getElementById('targetCard');
    
    const selectedDeck = deckDropdown.value;
    const selectedCardId = cardDropdown.value;
    
    if (!window.currentDictionaryWordData || !window.currentDictionaryWordData.word) {
      showError('No multimedia content available to add. Please look up a word first.');
      return;
    }
    const wordData = window.currentDictionaryWordData;

    if (!selectedDeck) { showError('Please select a deck'); return; }
    if (!selectedCardId) { showError('Please select a card'); return; }
    
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        if (result.success) {
          showSuccess(result.message || 'Multimedia content added to card successfully.');
          // Optionally, clear results or prompt for next action
          document.getElementById('dictionaryResults').style.display = 'none';
          document.getElementById('dictionaryWord').value = '';
          window.currentDictionaryWordData = null;
        } else {
          showError(result.message || 'Failed to add content to card.');
        }
      })
      .withFailureHandler(handleError) // handleError handles hideLoadingIndicator
      .addDictionaryContentToCard(selectedDeck, selectedCardId, wordData.word); // Server uses the word to re-fetch/cache
  }
</script>