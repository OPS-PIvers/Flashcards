<script>
/**
 * Initialize the application
 * 
 * @param {Object} options - Initialization options
 */
function initApp(options) {
  // Set defaults for missing options
  options = options || {};
  
  // Store app state with defensive initialization
  window.app = {
    isLoggedIn: Boolean(options.isLoggedIn),
    isAdmin: Boolean(options.isAdmin), // Explicitly convert to boolean
    userName: options.userName || '',
    currentDeck: null,
    currentCards: [],
    currentCardIndex: 0
  };
  
  console.log('App initialized with options:', {
    isLoggedIn: options.isLoggedIn,
    isAdmin: options.isAdmin,
    userName: options.userName
  });
  
  console.log('window.app state:', {
    isLoggedIn: window.app.isLoggedIn,
    isAdmin: window.app.isAdmin,
    userName: window.app.userName
  });
  
  // Setup event listeners
  setupEventListeners();
  
  // Adjust Admin Panel button visibility based on the definitive client-side admin state
  const adminButton = document.getElementById('adminPanelBtn');
  if (adminButton) {
    // The button should only be visible if the user is logged in (handled by parent 'userInfo' div visibility)
    // AND is an admin.
    adminButton.style.display = window.app.isAdmin ? 'block' : 'none';
    console.log(`Admin button visibility set to: ${window.app.isAdmin ? 'visible' : 'hidden'}`);
  } else {
    console.warn('Admin panel button element not found!');
  }
  
  // Load initial page - with proper authentication checking
  if (window.app.isLoggedIn) {
    // User info div should be visible if logged in
    const userInfo = document.getElementById('userInfo');
    if (userInfo) {
        userInfo.style.display = 'flex';
        // Ensure user name is displayed
        const userNameSpan = userInfo.querySelector('span');
        if (userNameSpan) {
            userNameSpan.textContent = `Welcome, ${window.app.userName}`;
        }
    }
    loadDeckList();
  } else {
    // User info div should be hidden if not logged in
    const userInfo = document.getElementById('userInfo');
    if (userInfo) {
        userInfo.style.display = 'none';
    }
    showLoginForm();
  }
  
  // Hide loading indicator
  hideLoadingIndicator();
}

/**
 * Setup core event listeners
 */
function setupEventListeners() {
  // Logout button
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', handleLogout);
  }
  
  // Admin panel button
  const adminPanelBtn = document.getElementById('adminPanelBtn');
  if (adminPanelBtn) {
    adminPanelBtn.addEventListener('click', loadAdminPanel);
    console.log('Admin panel button event listener attached');
  } else {
    console.warn('Admin panel button not found during event listener setup');
  }
}

/**
 * Handle user logout
 */
function handleLogout() {
  showLoadingIndicator();
  
  google.script.run
    .withSuccessHandler(function(result) {
      // Defensive check for null/undefined result
      if (!result) {
        hideLoadingIndicator();
        handleError('Server returned an empty response during logout');
        return;
      }
      
      // Update app state regardless of result success
      window.app.isLoggedIn = false;
      window.app.isAdmin = false;
      window.app.userName = '';
      
      // Hide user info
      const userInfo = document.getElementById('userInfo');
      if (userInfo) {
        userInfo.style.display = 'none';
      }
      
      // Hide admin button specifically as well (its parent is now hidden, but good practice)
      const adminButton = document.getElementById('adminPanelBtn');
      if (adminButton) {
        adminButton.style.display = 'none';
      }
      
      // Show login form
      showLoginForm();
      
      if (result.success) {
        showSuccess('Logged out successfully');
      } else {
        // Log error but still proceed with logout on client side
        console.error('Logout error on server:', result.message);
      }
      
      hideLoadingIndicator();
    })
    .withFailureHandler(function(error) {
      console.error('Logout failed:', error);
      
      // Force logout on client side even if server call fails
      window.app.isLoggedIn = false;
      window.app.isAdmin = false;
      window.app.userName = '';
      
      const userInfo = document.getElementById('userInfo');
      if (userInfo) {
        userInfo.style.display = 'none';
      }
      const adminButton = document.getElementById('adminPanelBtn');
      if (adminButton) {
        adminButton.style.display = 'none';
      }
      
      showLoginForm();
      handleError('Logout failed: ' + (error ? error.toString() : 'Unknown error'));
      hideLoadingIndicator(); // handleError might call this, but ensure it's called.
    })
    .logoutUser();
}

/**
 * Show the login form
 */
function showLoginForm() {
  const contentArea = document.getElementById('appContent');
  if (!contentArea) {
    console.error('Content area not found');
    return;
  }
  
  contentArea.innerHTML = '';
  
  // Get login form HTML
  const loginForm = document.getElementById('loginFormTemplate');
  if (loginForm && loginForm.content) { // check loginForm.content
    contentArea.appendChild(loginForm.content.cloneNode(true));
    
    // Setup login form event listeners
    const loginFormElement = document.getElementById('loginForm');
    if (loginFormElement) {
      loginFormElement.addEventListener('submit', handleLogin);
    } else {
      console.error('Login form element not found after template cloning');
    }
    
    // Optional: Setup password toggle
    const passwordToggle = document.getElementById('passwordToggle');
    if (passwordToggle) {
      passwordToggle.addEventListener('click', togglePasswordVisibility);
    }
  } else {
    contentArea.innerHTML = '<div class="card"><div class="card-title">Error</div><p>Login form template not found. Please refresh the page or contact your administrator.</p></div>';
  }
}

/**
 * Load the deck list
 */
function loadDeckList() {
  showLoadingIndicator();
  
  google.script.run
    .withSuccessHandler(function(result) {
      // Robust null/undefined checking
      if (!result) {
        handleError('Server returned an empty response');
        hideLoadingIndicator();
        return;
      }
      
      if (result.success) {
        displayDeckList(result.decks || [], result.dueCardsByDeck || {});
      } else {
        if (result.message === 'User not logged in' || result.message === 'User not logged in. Please log in to study decks.') { // Handle both messages
          // If not logged in, redirect to login
          handleLogout(); // Perform full logout client-side reset
          showError('Your session has expired. Please log in again.');
        } else {
          handleError(result.message || 'Unknown error occurred');
        }
      }
      
      hideLoadingIndicator();
    })
    .withFailureHandler(function(error) {
      const errorMessage = error && error.message ? error.message : (error ? error.toString() : 'Unknown error occurred');
      handleError(errorMessage);
      hideLoadingIndicator();
      
      // If there's a critical error (like auth failure), show login form as fallback
      // Check for specific error messages that imply an auth issue
      if (errorMessage.toLowerCase().includes('authorization') || errorMessage.toLowerCase().includes('logged in')) {
        handleLogout(); // Perform full logout client-side reset
      } else {
        // For other errors, it might be better to stay on the current view or show a generic error page
        // instead of forcefully logging out. For now, maintaining previous behavior to show login.
        // Consider if this is the best UX for all failure types.
        // showLoginForm(); // This was the previous implicit behavior
      }
    })
    .getUserDueCards();
}

/**
 * Display the list of available decks
 * 
 * @param {Array} decks - List of deck names
 * @param {Object} dueCardsByDeck - Due cards by deck
 */
function displayDeckList(decks, dueCardsByDeck) {
  // Ensure parameters are valid to prevent errors
  decks = decks || [];
  dueCardsByDeck = dueCardsByDeck || {};
  
  const contentArea = document.getElementById('appContent');
  if (!contentArea) {
    console.error('Cannot find appContent element');
    return;
  }
  
  let html = `
    <div class="card">
      <div class="card-title">Your Flashcard Decks</div>
      <div class="deck-list">
  `;
  
  if (decks.length === 0) {
    html += `<p>No flashcard decks available. Please contact an administrator or create one if you are an admin.</p>`;
  } else {
    decks.forEach(deckName => {
      const deckStats = dueCardsByDeck[deckName] || { totalCards: 0, dueCards: 0 };
      // Ensure deckName is escaped if it can contain special characters, though less likely for sheet names.
      // Using template literals, variables are automatically handled unless part of raw HTML attributes.
      html += `
        <div class="deck-card" data-deck="${escapeHtml(deckName)}">
          <div class="deck-title">${escapeHtml(deckName)}</div>
          <div class="deck-stats">
            <span>${deckStats.dueCards || 0} cards due</span>
            <span>${deckStats.totalCards || 0} total</span>
          </div>
        </div>
      `;
    });
  }
  
  html += `
      </div>
    </div>
  `;
  
  contentArea.innerHTML = html;
  
  // Add click event listeners to deck cards
  document.querySelectorAll('.deck-card').forEach(card => {
    card.addEventListener('click', function() {
      const deckName = this.getAttribute('data-deck');
      if (deckName) {
        loadDeck(deckName);
      } else {
        console.error('Deck name attribute missing');
      }
    });
  });
}

/**
 * Handle general errors
 * 
 * @param {string | Error | Object} errorMsg - Error message, Error object, or object with message property
 */
function handleError(errorMsg) {
  hideLoadingIndicator();
  
  let message;
  if (typeof errorMsg === 'string') {
    message = errorMsg;
  } else if (errorMsg && typeof errorMsg.message === 'string') {
    message = errorMsg.message;
  } else if (errorMsg && typeof errorMsg.toString === 'function') {
    message = errorMsg.toString();
  } else {
    message = 'An unknown error occurred';
  }

  console.error('Error:', message, errorMsg); // Log original error too
  
  // Show error notification
  const notification = document.createElement('div');
  notification.className = 'notification error';
  notification.innerHTML = `
    <div class="notification-content">
      <span class="material-icons">error</span>
      <span>${escapeHtml(message)}</span>
    </div>
    <button class="notification-close">
      <span class="material-icons">close</span>
    </button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
  
  // Add close button functionality
  const closeBtn = notification.querySelector('.notification-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      notification.remove();
    });
  }
}

/**
 * Show loading indicator
 */
function showLoadingIndicator() {
  const loader = document.getElementById('loadingIndicator');
  if (loader) {
    loader.style.display = 'flex';
  } else {
    console.warn('Loading indicator not found');
  }
}

/**
 * Hide loading indicator
 */
function hideLoadingIndicator() {
  const loader = document.getElementById('loadingIndicator');
  if (loader) {
    loader.style.display = 'none';
  }
}

/**
 * Show a success notification
 * 
 * @param {string} message - Success message
 */
function showSuccess(message) {
  // Default message if none provided
  message = message || 'Operation completed successfully';
  
  // Show success notification
  const notification = document.createElement('div');
  notification.className = 'notification success';
  notification.innerHTML = `
    <div class="notification-content">
      <span class="material-icons">check_circle</span>
      <span>${escapeHtml(message)}</span>
    </div>
    <button class="notification-close">
      <span class="material-icons">close</span>
    </button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
  
  // Add close button functionality
  const closeBtn = notification.querySelector('.notification-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      notification.remove();
    });
  }
}

/**
 * Show an error message to the user (now just an alias for handleError)
 * 
 * @param {string} message - Error message
 */
function showError(message) {
  handleError(message);
}

/**
 * Helper function to escape HTML special characters
 * 
 * @param {any} str - String to escape. If not a string, will be converted.
 * @return {string} Escaped string
 */
function escapeHtml(str) {
  if (typeof str !== 'string') {
    if (str === null || typeof str === 'undefined') {
        return '';
    }
    str = String(str);
  }
  
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>