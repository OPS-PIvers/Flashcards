<script>
  /**
   * Load the admin panel
   */
  function loadAdminPanel() {
    // First check admin access
    showLoadingIndicator();
    console.log('Admin panel loading: Checking admin access via server...');

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Admin access check result:', result);
        
        if (!result || !result.success) {
          showError('Server returned invalid response when checking admin access');
          hideLoadingIndicator();
          console.error('Admin access check failed - invalid server response:', result);
          return;
        }
        
        if (!result.isAdmin) {
          showError('Admin access required');
          hideLoadingIndicator();
          console.error('Admin access check failed - user is not an admin:', result);
          // Ensure we're seeing the proper state in client-side storage
          console.log('Current client app state:', window.app);
          return;
        }

        console.log('Admin access verified, loading admin panel UI');
        
        // Load admin panel template
        const contentArea = document.getElementById('appContent');
        const adminPanelTemplate = document.getElementById('adminPanelTemplate');
        if (adminPanelTemplate && adminPanelTemplate.content) {
          contentArea.innerHTML = ''; // Clear existing content
          contentArea.appendChild(adminPanelTemplate.content.cloneNode(true));
          console.log('Admin panel template loaded successfully');
        } else {
          showError('Admin panel template not found.');
          hideLoadingIndicator();
          console.error('Admin panel template missing or invalid');
          return;
        }
        
        // Setup tab switching
        setupAdminTabs();

        // Load deck list for Deck Management tab
        loadAdminDeckList();

        // Load user list for User Management tab
        loadUserList();

        // Initialize dictionary lookup for Dictionary Tools tab
        if (document.getElementById('dictionaryLookupTemplate')) { 
            const dictionaryTabContent = document.getElementById('dictionaryTab');
            const dictionaryTemplate = document.getElementById('dictionaryLookupTemplate');
            if (dictionaryTabContent && dictionaryTemplate && dictionaryTemplate.content) {
                 dictionaryTabContent.appendChild(dictionaryTemplate.content.cloneNode(true));
                 initDictionaryLookup(); 
                 console.log('Dictionary lookup template initialized');
            } else {
                console.warn('Dictionary template or tab content not found for dictionary tools.');
            }
        } else {
            console.warn('Dictionary lookup template not found in document.');
        }
        
        hideLoadingIndicator();
        console.log('Admin panel fully loaded');
      })
      .withFailureHandler(function(err) {
        console.error('Admin access check failed with error:', err);
        handleError(err);
        hideLoadingIndicator();
        console.log('Current client app state during error:', window.app);
      })
      .getAdminAccess();
  }

  /**
   * Setup tab switching in admin panel
   */
  function setupAdminTabs() {
    const tabs = document.querySelectorAll('.admin-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    console.log(`Found ${tabs.length} admin tabs and ${tabContents.length} tab contents`);

    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        this.classList.add('active');
        const tabName = this.getAttribute('data-tab');
        console.log(`Tab clicked: ${tabName}`);
        
        const activeContent = document.getElementById(tabName + 'Tab');
        if (activeContent) {
          activeContent.classList.add('active');
        } else {
          console.error(`Tab content not found for tab: ${tabName}`);
        }
      });
    });
    console.log('Admin tabs initialized');
  }

/**
 * Load deck list for admin panel
 */
function loadAdminDeckList() {
  showLoadingIndicator();
  console.log('Loading deck list for admin panel');
  
  const decksTabContent = document.getElementById('decksTab'); 
  if (!decksTabContent) {
      showError("Deck management area not found in admin panel.");
      hideLoadingIndicator();
      console.error('decksTab element not found in DOM');
      return;
  }
  
  // Replace the HTML content with a template for deck management
  decksTabContent.innerHTML = `
    <div class="card">
      <div class="card-title">Create New Deck</div>
      <div class="form-group">
        <label for="newDeckName" class="form-label">Deck Name</label>
        <div class="input-with-button">
          <input type="text" id="newDeckName" class="form-control" placeholder="Enter deck name">
          <button id="createDeckBtn" class="btn">Create</button>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">Manage Decks</div>
      <div id="adminDeckListContainer" class="admin-deck-list">
        <p>Loading decks...</p>
      </div>
    </div>
  `;
  
  const createDeckBtn = document.getElementById('createDeckBtn');
  if (createDeckBtn) {
    createDeckBtn.addEventListener('click', createNewDeck);
    console.log('Create deck button event listener attached');
  } else {
    console.warn('Create deck button not found after DOM update');
  }

  google.script.run
    .withSuccessHandler(function(result) {
      console.log('Admin deck list loaded:', result);
      if (result && result.success) {
        displayAdminDeckList(result.decks);
      } else {
        const errorMsg = result ? result.message : 'Unknown error occurred';
        handleError(errorMsg);
        const deckListContainer = document.getElementById('adminDeckListContainer');
        if(deckListContainer) {
          deckListContainer.innerHTML = `<p>Error loading decks: ${escapeHtml(errorMsg)}</p>`;
        }
        console.error('Failed to load admin deck list:', errorMsg);
      }
      hideLoadingIndicator();
    })
    .withFailureHandler(function(err){
      const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
      handleError(errorMsg);
      const deckListContainer = document.getElementById('adminDeckListContainer');
      if(deckListContainer) {
        deckListContainer.innerHTML = `<p>Error loading decks: ${escapeHtml(errorMsg)}</p>`;
      }
      console.error('Error in getAvailableDecks call:', errorMsg);
      hideLoadingIndicator();
    })
    .getAvailableDecks(false); 
}

  /**
   * Display deck list in admin panel
   * @param {Array} decks - List of deck names
   */
  function displayAdminDeckList(decks) {
    const deckListElement = document.getElementById('adminDeckListContainer'); 
    if (!deckListElement) {
      console.error('Admin deck list container not found.');
      return;
    }
    let html = '';
    const systemSheets = ['Config', 'Classes']; 
    const userDecks = Array.isArray(decks) ? decks.filter(deck => {
      const deckName = typeof deck === 'object' ? (deck.name || '') : deck;
      return !systemSheets.includes(deckName);
    }) : [];

    console.log(`Displaying ${userDecks.length} user decks in admin panel`);
    userDecks.forEach(deckName => { 
      const normalizedDeckName = typeof deckName === 'object' ? (deckName.name || deckName.toString()) : deckName.toString();
      html += `
        <div class="admin-deck-item">
          <div class="admin-deck-name">${escapeHtml(normalizedDeckName)}</div>
          <div class="admin-deck-actions">
            <button class="btn btn-outline btn-sm" data-action="edit" data-deck="${escapeHtml(normalizedDeckName)}">Edit</button>
            <button class="btn btn-outline btn-sm" data-action="delete" data-deck="${escapeHtml(normalizedDeckName)}">Delete</button>
          </div>
        </div>
      `;
    });
    if (userDecks.length === 0) {
      html = '<p>No user decks found. Create a new deck to get started.</p>';
    }
    deckListElement.innerHTML = html;

    deckListElement.querySelectorAll('[data-action="edit"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const deckName = this.getAttribute('data-deck');
        console.log(`Edit button clicked for deck: ${deckName}`);
        showDeckEditor(deckName);
      });
    });
    deckListElement.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const deckName = this.getAttribute('data-deck');
        console.log(`Delete button clicked for deck: ${deckName}`);
        deleteDeck(deckName);
      });
    });
  }
  
  /**
   * Create a new deck
   */
  function createNewDeck() {
    const newDeckNameInput = document.getElementById('newDeckName');
    if (!newDeckNameInput) {
        handleError("Deck name input field not found.");
        console.error('newDeckName input element not found');
        return;
    }
    const deckName = newDeckNameInput.value.trim();
    if (!deckName) {
      handleError('Deck name is required');
      return;
    }
    console.log(`Creating new deck: ${deckName}`);
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Create deck result:', result);
        if (result && result.success) {
          showSuccess(result.message || 'Deck created successfully');
          loadAdminDeckList(); 
          newDeckNameInput.value = '';
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to create deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in createDeck call:', errorMsg);
        hideLoadingIndicator();
      })
      .createDeck(deckName);
  }

  /**
   * Delete a deck
   * @param {string} deckName - Name of the deck to delete
   */
  function deleteDeck(deckName) {
    if (!confirm(`Are you sure you want to delete the deck "${escapeHtml(deckName)}"? This action cannot be undone.`)) {
      return;
    }
    console.log(`Deleting deck: ${deckName}`);
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Delete deck result:', result);
        if (result && result.success) {
          showSuccess(result.message || 'Deck deleted successfully');
          loadAdminDeckList();
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to delete deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in deleteDeck call:', errorMsg);
        hideLoadingIndicator();
      })
      .deleteDeck(deckName);
  }

  window.adminDeckCache = { cards: [], deckName: null };

  /**
   * Show deck editor (loads cards for a deck)
   * @param {string} deckName - Name of the deck to edit
   */
  function showDeckEditor(deckName) {
    console.log(`Loading deck editor for: ${deckName}`);
    showLoadingIndicator();
    window.adminDeckCache.deckName = deckName; 
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Get flashcards result:', result);
        if (result && result.success) {
          window.adminDeckCache.cards = result.cards || []; 
          console.log(`Loaded ${window.adminDeckCache.cards.length} cards for editing`);
          displayDeckEditorUI(deckName, window.adminDeckCache.cards);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to load flashcards for deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
          const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
          handleError(errorMsg);
          console.error('Error in getFlashcardsForDeck call:', errorMsg);
          hideLoadingIndicator();
      })
      .getFlashcardsForDeck(deckName);
  }

  /**
   * Display deck editor UI
   * @param {string} deckName - Name of the deck
   * @param {Array<Object>} cards - Array of flashcard objects
   */
  function displayDeckEditorUI(deckName, cards) {
    const decksTabContent = document.getElementById('decksTab');
    if (!decksTabContent) {
        showError("Deck management area not found.");
        console.error('decksTab element not found for editor UI');
        return;
    }
    let cardListHtml = '';
    if (!Array.isArray(cards) || cards.length === 0) {
      cardListHtml = '<p>No cards in this deck. Add a new card to get started.</p>';
    } else {
      cards.forEach(card => {
        const cardId = escapeHtml(card.id || card.FlashcardID || '');
        const sideA = escapeHtml(card.sideA || card.FlashcardSideA || '');
        const sideB = escapeHtml(card.sideB || card.FlashcardSideB || ''); 
        const sideC = escapeHtml(card.sideC || card.FlashcardSideC || ''); 
        
        // Extract study configuration 
        let studyConfig = { showSideB: true, showSideC: true, autoplayAudio: false }; 
        if (card.StudyConfig) {
          try {
            const parsedConfig = JSON.parse(card.StudyConfig);
            studyConfig = { ...studyConfig, ...parsedConfig };
          } catch (e) {
            console.error(`Error parsing study config for card ${cardId}:`, e);
          }
        }
        
        let tags = '';
        if (Array.isArray(card.tags)) tags = escapeHtml(card.tags.join(', '));
        else if (typeof card.tags === 'string') tags = escapeHtml(card.tags);
        else if (card.Tags) tags = Array.isArray(card.Tags) ? escapeHtml(card.Tags.join(', ')) : escapeHtml(String(card.Tags));
        
        cardListHtml += `
          <div class="admin-card-item" data-card-id="${cardId}">
            <div class="admin-card-content">
              <strong>Side A:</strong> ${sideA}<br>
              <strong>Side B (raw):</strong> ${sideB}<br>
              ${sideC ? `<strong>Side C (raw):</strong> ${sideC}<br>` : ''}
              ${tags ? `<strong>Tags:</strong> ${tags}<br>` : ''}
              <strong>Study Config:</strong> Show Side B: ${studyConfig.showSideB ? 'Yes' : 'No'}, 
              Show Side C: ${studyConfig.showSideC ? 'Yes' : 'No'},
              Autoplay Audio: ${studyConfig.autoplayAudio ? 'Yes' : 'No'}
            </div>
            <div class="admin-card-actions">
              <button class="btn btn-outline btn-sm" data-action="edit-card" data-card-id="${cardId}">Edit</button>
              <button class="btn btn-outline btn-sm" data-action="delete-card" data-card-id="${cardId}">Delete</button>
              <button class="btn btn-outline btn-sm" data-action="add-dictionary" data-card-id="${cardId}">Dictionary</button>
            </div>
          </div>
        `;
      });
    }

    decksTabContent.innerHTML = `
      <div class="card">
        <div class="card-title">Editing Deck: ${escapeHtml(deckName)}</div>
        <div class="form-actions">
          <button id="backToAdminDecks" class="btn btn-outline">Back to Decks</button>
          <button id="showAddCardFormBtn" class="btn">Add New Card</button>
        </div>
        <div id="addCardFormContainer" style="display: none; margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px;">
          <h3>Add New Card</h3>
          <div class="form-group">
            <label for="newCardSideA" class="form-label">Side A (Question/Word)</label>
            <div class="input-with-button">
              <input type="text" id="newCardSideA" class="form-control" required>
              <button id="getAudioBtnA" class="btn btn-sm">Get Audio</button>
            </div>
            <div id="audioPreviewContainerA" class="preview-container" style="display: none; margin-top: 10px;">
              <audio id="audioPreviewA" controls style="width: 100%;"></audio>
            </div>
          </div>
          <div class="form-group">
            <label for="newCardSideB" class="form-label">Side B (Answer/Text)</label>
            <div class="input-with-button">
              <input type="text" id="newCardSideB" class="form-control">
              <button id="getImageBtn" class="btn btn-sm">Get Image</button>
            </div>
            <div id="imagePreviewContainer" class="preview-container" style="display: none; margin-top: 10px;">
              <img id="imagePreview" style="max-width: 100%; max-height: 150px; object-fit: contain;">
            </div>
          </div>
          <div class="form-group">
            <label for="newCardSideC" class="form-label">Side C (Additional Info/Text)</label>
            <div class="input-with-button">
              <textarea id="newCardSideC" class="form-control" rows="3"></textarea>
              <button id="getAudioBtn" class="btn btn-sm">Get Audio</button>
            </div>
            <div id="audioPreviewContainer" class="preview-container" style="display: none; margin-top: 10px;">
              <audio id="audioPreview" controls style="width: 100%;"></audio>
            </div>
          </div>
          <div class="form-group">
            <label for="newCardTags" class="form-label">Tags (comma-separated)</label>
            <input type="text" id="newCardTags" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">Study Configuration</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="studySideA" checked disabled> 
                <label for="studySideA">Side A (Always shown on front)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="studySideB" checked> 
                <label for="studySideB">Show Side B on back</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="studySideC" checked> 
                <label for="studySideC">Show Side C on back</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="studyAutoplay"> 
                <label for="studyAutoplay">Auto-play audio when card is flipped</label>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button id="submitNewCardBtn" class="btn btn-secondary">Save Card</button>
            <button id="cancelAddCardBtn" class="btn btn-outline">Cancel</button>
          </div>
        </div>
        <div class="admin-card-list" id="cardListDisplay">${cardListHtml}</div>
      </div>
    `;
    console.log('Deck editor UI rendered, attaching event listeners');
    
    document.getElementById('backToAdminDecks').addEventListener('click', loadAdminDeckList);
    document.getElementById('showAddCardFormBtn').addEventListener('click', function() {
      document.getElementById('addCardFormContainer').style.display = 'block';
      this.style.display = 'none';
    });
    document.getElementById('cancelAddCardBtn').addEventListener('click', function() {
      document.getElementById('addCardFormContainer').style.display = 'none';
      document.getElementById('newCardSideA').value = '';
      document.getElementById('newCardSideB').value = '';
      document.getElementById('newCardSideC').value = '';
      document.getElementById('newCardTags').value = '';
      document.getElementById('newCardSideB').removeAttribute('data-image-url');
      document.getElementById('newCardSideC').removeAttribute('data-audio-url');
      document.getElementById('newCardSideA').removeAttribute('data-audio-url');
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('audioPreviewContainer').style.display = 'none';
      document.getElementById('audioPreviewContainerA').style.display = 'none';
      document.getElementById('studySideB').checked = true; 
      document.getElementById('studySideC').checked = true; 
      document.getElementById('studyAutoplay').checked = false;
      document.getElementById('showAddCardFormBtn').style.display = 'inline-block';
    });
    document.getElementById('submitNewCardBtn').addEventListener('click', function() { addNewCardToDeck(deckName); });
    document.getElementById('getImageBtn').addEventListener('click', function() {
      const wordInput = document.getElementById('newCardSideA').value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'image', 'newCardSideB', 'imagePreviewContainer', 'imagePreview');
    });
    document.getElementById('getAudioBtn').addEventListener('click', function() {
      const wordInput = document.getElementById('newCardSideA').value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'audio', 'newCardSideC', 'audioPreviewContainer', 'audioPreview');
    });
    document.getElementById('getAudioBtnA').addEventListener('click', function() {
      const wordInput = document.getElementById('newCardSideA').value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'audio', 'newCardSideA', 'audioPreviewContainerA', 'audioPreviewA');
    });
    
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="edit-card"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        console.log(`Edit card button clicked for card ID: ${cardId}`);
        const cardToEdit = window.adminDeckCache.cards.find(c => (c.id === cardId) || (c.FlashcardID === cardId));
        if (cardToEdit) showCardEditorForm(this.closest('.admin-card-item'), cardToEdit, deckName);
        else { showError("Card data not found for editing."); console.error(`Card with ID ${cardId} not found`); }
      });
    });
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="delete-card"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        deleteCardFromDeck(cardId, deckName);
      });
    });
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="add-dictionary"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        const cardForDict = window.adminDeckCache.cards.find(c => (c.id === cardId) || (c.FlashcardID === cardId));
        if (cardForDict) handleDictionaryForCard(cardForDict, deckName);
        else { showError("Card data not found for dictionary action."); console.error(`Card with ID ${cardId} not found`); }
      });
    });
  }

  /**
   * Adds a new flashcard to the specified deck using data from the form.
   * This function is called when the "Save Card" button in the "Add New Card" form is clicked.
   * @param {string} deckName - The name of the deck to add the card to.
   */
  function addNewCardToDeck(deckName) {
    // Get references to form input elements
    const sideA_input = document.getElementById('newCardSideA');
    const sideB_input = document.getElementById('newCardSideB');
    const sideC_input = document.getElementById('newCardSideC');
    const tags_input = document.getElementById('newCardTags');

    // Get study configuration checkboxes
    const showSideB_checkbox = document.getElementById('studySideB');
    const showSideC_checkbox = document.getElementById('studySideC');
    const autoplayAudio_checkbox = document.getElementById('studyAutoplay'); 

    // Get values from the input fields
    const sideA = sideA_input.value.trim();
    const sideB = sideB_input.value.trim();
    const sideC = sideC_input.value.trim();
    const tags = tags_input.value.trim();

    // Get boolean values from checkboxes
    const showSideB = showSideB_checkbox.checked;
    const showSideC = showSideC_checkbox.checked;
    const autoplayAudio = autoplayAudio_checkbox ? autoplayAudio_checkbox.checked : false;

    // Validate that Side A is not empty
    if (!sideA) {
      handleError('Side A is required for a new card.');
      return;
    }

    // Retrieve multimedia URLs stored in dataset attributes (if any)
    const imageUrl = sideB_input.dataset.imageUrl || null;
    const audioUrlC = sideC_input.dataset.audioUrl || null;
    const audioUrlA = sideA_input.dataset.audioUrl || null; 

    // Prepare card data object for the server
    const cardData = {
      sideA: sideA,
      sideB: sideB,
      sideC: sideC,
      tags: tags,
      showSideB: showSideB,
      showSideC: showSideC,
      autoplayAudio: autoplayAudio
    };

    console.log('Adding new card with data:', cardData, 'Image:', imageUrl, 'AudioC:', audioUrlC, 'AudioA:', audioUrlA);
    showLoadingIndicator(); 

    // Call the server-side function to add the flashcard
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator(); 
        if (result && result.success) {
          showSuccess('New card added successfully!');
          
          // Clear the form fields and reset previews
          sideA_input.value = '';
          sideB_input.value = '';
          sideC_input.value = '';
          tags_input.value = '';
          
          showSideB_checkbox.checked = true;
          showSideC_checkbox.checked = true;
          if(autoplayAudio_checkbox) autoplayAudio_checkbox.checked = false;


          sideB_input.removeAttribute('data-image-url');
          sideC_input.removeAttribute('data-audio-url');
          sideA_input.removeAttribute('data-audio-url');
          
          const imagePreviewContainer = document.getElementById('imagePreviewContainer');
          if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
          const audioPreviewContainer = document.getElementById('audioPreviewContainer');
          if (audioPreviewContainer) audioPreviewContainer.style.display = 'none';
          const audioPreviewContainerA = document.getElementById('audioPreviewContainerA');
          if (audioPreviewContainerA) audioPreviewContainerA.style.display = 'none';
          
          const addCardFormContainer = document.getElementById('addCardFormContainer');
          if (addCardFormContainer) addCardFormContainer.style.display = 'none';
          const showAddCardFormBtn = document.getElementById('showAddCardFormBtn');
          if (showAddCardFormBtn) showAddCardFormBtn.style.display = 'inline-block';
          
          showDeckEditor(deckName); 
        } else {
          handleError(result ? result.message : 'Failed to add new card.');
        }
      })
      .withFailureHandler(function(err) {
        hideLoadingIndicator(); 
        handleError(err.message || 'An error occurred while adding the card.');
      })
      .addFlashcard(deckName, cardData, imageUrl, audioUrlC, audioUrlA); 
  }


  /**
   * Handle dictionary lookup for a specific card, pre-filling dictionary tab.
   * @param {Object} card - The card object
   * @param {string} deckName - The name of the current deck
   */
  function handleDictionaryForCard(card, deckName) {
    const dictionaryTabButton = document.querySelector('.admin-tab[data-tab="dictionary"]');
    if (dictionaryTabButton) {
        console.log('Switching to dictionary tab for card:', card.id || card.FlashcardID);
        dictionaryTabButton.click(); 
    } else {
        showError("Dictionary tab not found."); return;
    }

    setTimeout(() => {
        const dictionaryWordInput = document.getElementById('dictionaryWord');
        const lookupBtn = document.getElementById('lookupWordBtn');
        const targetDeckDropdown = document.getElementById('targetDeck');

        if (!dictionaryWordInput || !lookupBtn || !targetDeckDropdown) {
            showError("Dictionary UI elements not found. Ensure the template is loaded."); return;
        }
        let wordToLookup = (card.sideA || card.FlashcardSideA || '').trim().split(/\s+/).slice(0, 3).join(' ');
        console.log(`Pre-filling dictionary with word: "${wordToLookup}" for card ID: ${card.id || card.FlashcardID}`);
        dictionaryWordInput.value = wordToLookup || '';
        targetDeckDropdown.value = deckName;
        targetDeckDropdown.dispatchEvent(new Event('change')); 

        const intervalCheck = setInterval(function() {
            const targetCardDropdown = document.getElementById('targetCard');
            if (targetCardDropdown && targetCardDropdown.options.length > 1) { 
                const cardIdToSelect = card.id || card.FlashcardID;
                targetCardDropdown.value = cardIdToSelect;
                if (targetCardDropdown.value === cardIdToSelect) {
                    console.log(`Successfully selected card ${cardIdToSelect} in dictionary dropdown`);
                    clearInterval(intervalCheck);
                    if (wordToLookup && lookupBtn) lookupBtn.click();
                } else { console.warn(`Failed to select card ${cardIdToSelect} in dropdown.`); }
            }
        }, 200);
        setTimeout(() => { clearInterval(intervalCheck); console.log('Dictionary card selection timeout.'); }, 5000);
    }, 150);
  }

  /**
   * Show card editor form inline
   * @param {Element} cardElement - The .admin-card-item element
   * @param {Object} card - The card object
   * @param {string} deckName - Name of the deck
   */
  function showCardEditorForm(cardElement, card, deckName) {
    const originalContentHtml = cardElement.innerHTML;
    const cardId = card.id || card.FlashcardID || '';
    
    const sideA_text = (card.sideA || card.FlashcardSideA || '');
    let sideB_text = (card.sideB || card.FlashcardSideB || '');
    let sideC_text = (card.sideC || card.FlashcardSideC || '');

    const imageTagMatchB = sideB_text.match(/\[IMAGE:([^\]]+)\]/);
    const audioTagMatchC = sideC_text.match(/\[AUDIO:([^\]]+)\]/);
    const audioTagMatchA = sideA_text.match(/\[AUDIO:([^\]]+)\]/); 
    
    const existingImageUrl = imageTagMatchB ? imageTagMatchB[1] : null;
    const existingAudioUrlC = audioTagMatchC ? audioTagMatchC[1] : null;
    const existingAudioUrlA = audioTagMatchA ? audioTagMatchA[1] : null; 
    
    let studyConfig = { showSideB: true, showSideC: true, autoplayAudio: false }; 
    if (card.StudyConfig) {
      try {
        const parsedConfig = JSON.parse(card.StudyConfig);
        studyConfig = { ...studyConfig, ...parsedConfig };
      } catch (e) {
        console.error(`Error parsing study config for card ${cardId}:`, e);
      }
    }

    let tagsValue = '';
    if (Array.isArray(card.tags)) tagsValue = card.tags.join(', ');
    else if (typeof card.tags === 'string') tagsValue = card.tags;
    else if (card.Tags) tagsValue = Array.isArray(card.Tags) ? card.Tags.join(', ') : String(card.Tags);
    
    console.log(`Showing editor form for card: ${cardId}`);
    cardElement.innerHTML = `
      <div class="card-edit-form" style="background-color: #f9f9f9; padding: 10px; border-radius: 4px;">
        <h4>Edit Card (ID: ${escapeHtml(cardId)})</h4>
        <div class="form-group">
          <label for="editCardSideA-${cardId}" class="form-label">Side A (Question/Word)</label>
          <div class="input-with-button">
            <input type="text" id="editCardSideA-${cardId}" class="form-control" value="${escapeHtml(sideA_text.replace(/\[AUDIO:[^\]]+\]\s*/gi, '').trim())}" required>
            <button id="editGetAudioBtnA-${cardId}" class="btn btn-sm">Get Audio</button>
          </div>
          <div id="editAudioPreviewContainerA-${cardId}" class="preview-container" style="display: ${existingAudioUrlA ? 'block' : 'none'}; margin-top: 10px;">
            <audio id="editAudioPreviewA-${cardId}" src="${existingAudioUrlA || ''}" controls style="width: 100%;"></audio>
          </div>
        </div>
        <div class="form-group">
          <label for="editCardSideB-${cardId}" class="form-label">Side B (Answer/Text)</label>
          <div class="input-with-button">
            <input type="text" id="editCardSideB-${cardId}" class="form-control" value="${escapeHtml(sideB_text.replace(/\[IMAGE:[^\]]+\]\s*/gi, '').trim())}">
            <button id="editGetImageBtn-${cardId}" class="btn btn-sm">Get Image</button>
          </div>
          <div id="editImagePreviewContainer-${cardId}" class="preview-container" style="display: ${existingImageUrl ? 'block' : 'none'}; margin-top: 10px;">
            <img id="editImagePreview-${cardId}" src="${existingImageUrl || ''}" style="max-width: 100%; max-height: 150px; object-fit: contain;">
          </div>
        </div>
        <div class="form-group">
          <label for="editCardSideC-${cardId}" class="form-label">Side C (Additional Info/Text)</label>
          <div class="input-with-button">
            <textarea id="editCardSideC-${cardId}" class="form-control" rows="3">${escapeHtml(sideC_text.replace(/\[AUDIO:[^\]]+\]\s*/gi, '').replace(/\[Source:[^\]]+\]\s*/gi, '').trim())}</textarea>
            <button id="editGetAudioBtn-${cardId}" class="btn btn-sm">Get Audio</button>
          </div>
          <div id="editAudioPreviewContainer-${cardId}" class="preview-container" style="display: ${existingAudioUrlC ? 'block' : 'none'}; margin-top: 10px;">
            <audio id="editAudioPreview-${cardId}" src="${existingAudioUrlC || ''}" controls style="width: 100%;"></audio>
          </div>
        </div>
        <div class="form-group">
          <label for="editCardTags-${cardId}" class="form-label">Tags</label>
          <input type="text" id="editCardTags-${cardId}" class="form-control" value="${escapeHtml(tagsValue)}">
        </div>
        <div class="form-group">
          <label class="form-label">Study Configuration</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="editStudySideA-${cardId}" checked disabled> 
              <label for="editStudySideA-${cardId}">Side A (Always shown on front)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="editStudySideB-${cardId}" ${studyConfig.showSideB ? 'checked' : ''}> 
              <label for="editStudySideB-${cardId}">Show Side B on back</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="editStudySideC-${cardId}" ${studyConfig.showSideC ? 'checked' : ''}> 
              <label for="editStudySideC-${cardId}">Show Side C on back</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="editAutoplayAudio-${cardId}" ${studyConfig.autoplayAudio ? 'checked' : ''}> 
              <label for="editAutoplayAudio-${cardId}">Auto-play audio when card is flipped</label>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary btn-sm" data-action="save-edit" data-card-id="${cardId}">Save</button>
          <button class="btn btn-outline btn-sm" data-action="cancel-edit">Cancel</button>
        </div>
      </div>
    `;
    
    if (existingImageUrl) document.getElementById(`editCardSideB-${cardId}`).dataset.imageUrl = existingImageUrl;
    if (existingAudioUrlC) document.getElementById(`editCardSideC-${cardId}`).dataset.audioUrl = existingAudioUrlC;
    if (existingAudioUrlA) document.getElementById(`editCardSideA-${cardId}`).dataset.audioUrl = existingAudioUrlA;

    cardElement.querySelector('[data-action="save-edit"]').addEventListener('click', function() { updateEditedCard(cardId, deckName); });
    cardElement.querySelector('[data-action="cancel-edit"]').addEventListener('click', function() {
      cardElement.innerHTML = originalContentHtml; 
      const restoredEditBtn = cardElement.querySelector('[data-action="edit-card"]');
      if (restoredEditBtn) restoredEditBtn.addEventListener('click', () => showCardEditorForm(cardElement, card, deckName));
      const restoredDeleteBtn = cardElement.querySelector('[data-action="delete-card"]');
      if (restoredDeleteBtn) restoredDeleteBtn.addEventListener('click', () => deleteCardFromDeck(cardId, deckName));
      const restoredDictBtn = cardElement.querySelector('[data-action="add-dictionary"]');
      if (restoredDictBtn) restoredDictBtn.addEventListener('click', () => handleDictionaryForCard(card, deckName));
    });
    
    document.getElementById(`editGetImageBtn-${cardId}`).addEventListener('click', function() {
      const wordInput = document.getElementById(`editCardSideA-${cardId}`).value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'image', `editCardSideB-${cardId}`, `editImagePreviewContainer-${cardId}`, `editImagePreview-${cardId}`);
    });
    
    document.getElementById(`editGetAudioBtn-${cardId}`).addEventListener('click', function() {
      const wordInput = document.getElementById(`editCardSideA-${cardId}`).value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'audio', `editCardSideC-${cardId}`, `editAudioPreviewContainer-${cardId}`, `editAudioPreview-${cardId}`);
    });
    
    document.getElementById(`editGetAudioBtnA-${cardId}`).addEventListener('click', function() {
      const wordInput = document.getElementById(`editCardSideA-${cardId}`).value.trim();
      if (!wordInput) { showError('Please enter a word in Side A first'); return; }
      fetchMultimediaForItem(wordInput, 'audio', `editCardSideA-${cardId}`, `editAudioPreviewContainerA-${cardId}`, `editAudioPreviewA-${cardId}`);
    });
  }

  /**
   * Fetches multimedia (image or audio) for a word and displays it in the preview.
   * Stores the URL in the target input's dataset.
   * @param {string} word - The word to look up.
   * @param {'image'|'audio'} type - Type of media to fetch.
   * @param {string} targetInputId - ID of the input field to store the URL (e.g., 'newCardSideB').
   * @param {string} previewContainerId - ID of the preview container element.
   * @param {string} previewElementId - ID of the img or audio element for preview.
   */
  function fetchMultimediaForItem(word, type, targetInputId, previewContainerId, previewElementId) {
    showLoadingIndicator();
    console.log(`Fetching ${type} for word: "${word}"`);
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        console.log(`Multimedia lookup result for ${type}:`, result);
        
        const targetInput = document.getElementById(targetInputId);
        const previewContainer = document.getElementById(previewContainerId);
        const previewElement = document.getElementById(previewElementId);

        if (!targetInput || !previewContainer || !previewElement) {
          console.error(`One or more UI elements not found for ${type} preview.`);
          showError('UI error displaying preview.');
          return;
        }
        
        let urlToUse = null;
        if (type === 'image' && result.imageUrl) urlToUse = result.imageUrl;
        if (type === 'audio' && result.audioUrl) urlToUse = result.audioUrl;

        if (result && result.success && urlToUse) {
          if (type === 'image') {
            previewElement.src = urlToUse;
            previewElement.alt = `Preview for ${word}`;
            targetInput.dataset.imageUrl = urlToUse;
          } else if (type === 'audio') {
            previewElement.src = urlToUse;
            targetInput.dataset.audioUrl = urlToUse;
          }
          previewContainer.style.display = 'block';
          showSuccess(`${type.charAt(0).toUpperCase() + type.slice(1)} found for "${word}"`);
        } else {
          const specificMessage = (type === 'image' && result.message.includes("Image:")) || (type === 'audio' && result.message.includes("Audio:"))
                                ? result.message
                                : `No ${type} found for "${word}". General: ${result.message}`;
          showError(specificMessage);
          previewContainer.style.display = 'none';
          previewElement.src = '';
          if (type === 'image') targetInput.removeAttribute('data-image-url');
          if (type === 'audio') targetInput.removeAttribute('data-audio-url');
        }
      })
      .withFailureHandler(function(err) {
        hideLoadingIndicator();
        showError(`Error fetching ${type}: ` + (err.message || err));
        console.error(`Error in ${type} lookup:`, err);
      })
      .previewDictionaryContent(word); 
  }
  
  /**
   * Update an edited card, now passing image/audio URLs separately
   * @param {string} cardId - ID of the card
   * @param {string} deckName - Name of the deck
   */
  function updateEditedCard(cardId, deckName) {
    const sideA_input = document.getElementById(`editCardSideA-${cardId}`);
    const sideB_input = document.getElementById(`editCardSideB-${cardId}`);
    const sideC_input = document.getElementById(`editCardSideC-${cardId}`);
    
    const sideA_text = sideA_input.value.trim();
    const sideB_text = sideB_input.value.trim();
    const sideC_text = sideC_input.value.trim();
    const tags = document.getElementById(`editCardTags-${cardId}`).value.trim();
    
    const showSideB = document.getElementById(`editStudySideB-${cardId}`).checked;
    const showSideC = document.getElementById(`editStudySideC-${cardId}`).checked;
    const autoplayAudio = document.getElementById(`editAutoplayAudio-${cardId}`).checked;

    if (!sideA_text) {
      handleError('Side A is required.');
      return;
    }
    
    console.log(`Updating card ${cardId} in deck ${deckName}`);
    showLoadingIndicator();
    
    const imageUrl = sideB_input.dataset.imageUrl || null;
    const audioUrlC = sideC_input.dataset.audioUrl || null;
    const audioUrlA = sideA_input.dataset.audioUrl || null;
        
    const cardData = { 
      sideA: sideA_text, 
      sideB: sideB_text, 
      sideC: sideC_text, 
      tags: tags,
      showSideB: showSideB,
      showSideC: showSideC,
      autoplayAudio: autoplayAudio
    };

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Update flashcard result:', result);
        hideLoadingIndicator();
        if (result && result.success) {
          showSuccess('Card updated successfully!');
          showDeckEditor(deckName);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to update flashcard:', errorMsg);
        }
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in updateFlashcard call:', errorMsg);
        hideLoadingIndicator();
      })
      .updateFlashcard(deckName, cardId, cardData, imageUrl, audioUrlC, audioUrlA); 
  }

  /**
   * Delete a card from a deck
   * @param {string} cardId - ID of the card
   * @param {string} deckName - Name of the deck
   */
  function deleteCardFromDeck(cardId, deckName) {
    if (!confirm(`Are you sure you want to delete card ID "${escapeHtml(cardId)}"? This cannot be undone.`)) {
      return;
    }
    console.log(`Deleting card ${cardId} from deck ${deckName}`);
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Delete flashcard result:', result);
        hideLoadingIndicator();
        if (result && result.success) {
          showSuccess('Card deleted successfully!');
          showDeckEditor(deckName); 
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to delete flashcard:', errorMsg);
        }
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in deleteFlashcard call:', errorMsg);
        hideLoadingIndicator();
      })
      .deleteFlashcard(deckName, cardId);
  }

  /**
   * Load user list for admin panel
   */
  function loadUserList() {
    showLoadingIndicator();
    console.log('Loading user list for admin panel');
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Get users result:', result);
        hideLoadingIndicator();
        if (result && result.success) {
          displayUserList(result.users || []);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          const userListTbody = document.querySelector('#userList table tbody');
          if (userListTbody) userListTbody.innerHTML = `<tr><td colspan="5">Error loading users: ${escapeHtml(errorMsg)}</td></tr>`;
          console.error('Failed to load users:', errorMsg);
        }
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        const userListTbody = document.querySelector('#userList table tbody');
        if (userListTbody) userListTbody.innerHTML = `<tr><td colspan="5">Error loading users: ${escapeHtml(errorMsg)}</td></tr>`;
        console.error('Error in getUsers call:', errorMsg);
        hideLoadingIndicator();
      })
      .getUsers();
  }

  /**
   * Display user list in admin panel
   * @param {Array<Object>} users - Array of user objects
   */
  function displayUserList(users) {
    const userListTableBody = document.querySelector('#userList table tbody');
    if (!userListTableBody) {
      console.error('User list table body not found.');
      return;
    }
    let html = '';
    if (!Array.isArray(users) || users.length === 0) {
      html = '<tr><td colspan="5">No users found.</td></tr>';
    } else {
      console.log(`Displaying ${users.length} users in admin panel`);
      users.forEach(user => {
        const isAdmin = user.IsAdmin === true || String(user.IsAdmin).toLowerCase() === 'true';
        const lastLogin = user.LastLogin ? new Date(user.LastLogin).toLocaleString() : 'Never';
        html += `
          <tr>
            <td>${escapeHtml(user.StudentFirst || '')} ${escapeHtml(user.StudentLast || '')}</td>
            <td>${escapeHtml(user.UserName || '')}</td>
            <td>${isAdmin ? 'Admin' : 'Student'}</td>
            <td>${escapeHtml(lastLogin)}</td>
            <td>
              <button class="btn btn-outline btn-sm" data-action="view-progress" data-username="${escapeHtml(user.UserName || '')}" disabled>Progress</button>
            </td>
          </tr>
        `;
      });
    }
    userListTableBody.innerHTML = html;
    userListTableBody.querySelectorAll('[data-action="view-progress"]').forEach(btn => {
      if (!btn.disabled) {
        btn.addEventListener('click', function() {
          const username = this.getAttribute('data-username');
          console.log(`View progress button clicked for user: ${username}`);
          alert('View progress for ' + username + ' (not implemented yet)');
        });
      }
    });
  }
</script>
