<script>
  /**
   * Load the admin panel
   */
  function loadAdminPanel() {
    // First check admin access
    showLoadingIndicator();
    console.log('Admin panel loading: Checking admin access via server...');

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Admin access check result:', result);
        
        if (!result || !result.success) {
          showError('Server returned invalid response when checking admin access');
          hideLoadingIndicator();
          console.error('Admin access check failed - invalid server response:', result);
          return;
        }
        
        if (!result.isAdmin) {
          showError('Admin access required');
          hideLoadingIndicator();
          console.error('Admin access check failed - user is not an admin:', result);
          // Ensure we're seeing the proper state in client-side storage
          console.log('Current client app state:', window.app);
          return;
        }

        console.log('Admin access verified, loading admin panel UI');
        
        // Load admin panel template
        const contentArea = document.getElementById('appContent');
        const adminPanelTemplate = document.getElementById('adminPanelTemplate');
        if (adminPanelTemplate && adminPanelTemplate.content) {
          contentArea.innerHTML = ''; // Clear existing content
          contentArea.appendChild(adminPanelTemplate.content.cloneNode(true));
          console.log('Admin panel template loaded successfully');
        } else {
          showError('Admin panel template not found.');
          hideLoadingIndicator();
          console.error('Admin panel template missing or invalid');
          return;
        }
        
        // Setup tab switching
        setupAdminTabs();

        // Load deck list for Deck Management tab
        loadAdminDeckList();

        // Load user list for User Management tab
        loadUserList();

        // Initialize dictionary lookup for Dictionary Tools tab
        // This will only add listeners etc. if the dictionary tab is active
        // and its content (from dictionaryLookupTemplate) is present.
        // Ensure dictionaryLookupTemplate is included in adminPanelTemplate's dictionaryTab.
        if (document.getElementById('dictionaryLookupTemplate')) { // Check if template exists
            const dictionaryTabContent = document.getElementById('dictionaryTab');
            const dictionaryTemplate = document.getElementById('dictionaryLookupTemplate');
            if (dictionaryTabContent && dictionaryTemplate && dictionaryTemplate.content) {
                 dictionaryTabContent.appendChild(dictionaryTemplate.content.cloneNode(true));
                 initDictionaryLookup(); // Now safe to call
                 console.log('Dictionary lookup template initialized');
            } else {
                console.warn('Dictionary template or tab content not found');
            }
        } else {
            console.warn('Dictionary lookup template not found');
        }
        
        hideLoadingIndicator();
        console.log('Admin panel fully loaded');
      })
      .withFailureHandler(function(err) {
        console.error('Admin access check failed with error:', err);
        handleError(err);
        hideLoadingIndicator();
        // Show current client state for debugging
        console.log('Current client app state during error:', window.app);
      })
      .getAdminAccess();
  }

  /**
   * Setup tab switching in admin panel
   */
  function setupAdminTabs() {
    const tabs = document.querySelectorAll('.admin-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    console.log(`Found ${tabs.length} admin tabs and ${tabContents.length} tab contents`);

    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs and content
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Add active class to clicked tab and corresponding content
        this.classList.add('active');
        const tabName = this.getAttribute('data-tab');
        console.log(`Tab clicked: ${tabName}`);
        
        const activeContent = document.getElementById(tabName + 'Tab');
        if (activeContent) {
          activeContent.classList.add('active');
        } else {
          console.error(`Tab content not found for tab: ${tabName}`);
        }
      });
    });

    console.log('Admin tabs initialized');
  }

  /**
   * Load deck list for admin panel
   */
  function loadAdminDeckList() {
    showLoadingIndicator();
    console.log('Loading deck list for admin panel');
    
    const decksTabContent = document.getElementById('decksTab'); // Target specific area
    if (!decksTabContent) {
        showError("Deck management area not found in admin panel.");
        hideLoadingIndicator();
        console.error('decksTab element not found in DOM');
        return;
    }
    // Initially show main deck list view within decksTab
    decksTabContent.innerHTML = `
        <div class="card">
            <div class="card-title">Create New Deck</div>
            <div class="form-group">
                <label for="newDeckName" class="form-label">Deck Name</label>
                <div class="input-with-button">
                    <input type="text" id="newDeckName" class="form-control" placeholder="Enter deck name">
                    <button id="createDeckBtn" class="btn">Create</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Manage Decks</div>
            <div id="adminDeckListContainer" class="admin-deck-list">
                <p>Loading decks...</p>
            </div>
        </div>
    `;
    // Add event listener to create deck button *after* it's in the DOM
    const createDeckBtn = document.getElementById('createDeckBtn');
    if (createDeckBtn) {
      createDeckBtn.addEventListener('click', createNewDeck);
      console.log('Create deck button event listener attached');
    } else {
      console.warn('Create deck button not found after DOM update');
    }


    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Admin deck list loaded:', result);
        
        if (result && result.success) {
          displayAdminDeckList(result.decks);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          const deckListContainer = document.getElementById('adminDeckListContainer');
          if(deckListContainer) {
            deckListContainer.innerHTML = `<p>Error loading decks: ${escapeHtml(errorMsg)}</p>`;
          }
          console.error('Failed to load admin deck list:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err){
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        const deckListContainer = document.getElementById('adminDeckListContainer');
        if(deckListContainer) {
          deckListContainer.innerHTML = `<p>Error loading decks: ${escapeHtml(errorMsg)}</p>`;
        }
        console.error('Error in getAvailableDecks call:', errorMsg);
        hideLoadingIndicator();
      })
      .getAvailableDecks(false); // Get all decks, including system ones if needed for some reason, or true for user decks
  }

  /**
   * Display deck list in admin panel
   * @param {Array} decks - List of deck names
   */
  function displayAdminDeckList(decks) {
    const deckListElement = document.getElementById('adminDeckListContainer'); // Target specific container

    if (!deckListElement) {
      console.error('Admin deck list container not found.');
      return;
    }

    let html = '';
    const systemSheets = ['Config', 'Classes']; // Define system sheets to filter out
    const userDecks = Array.isArray(decks) ? decks.filter(deck => {
      const deckName = typeof deck === 'object' ? (deck.name || '') : deck;
      return !systemSheets.includes(deckName);
    }) : [];

    console.log(`Displaying ${userDecks.length} user decks in admin panel`);

    userDecks.forEach(deckName => { // Assuming decks is an array of strings
      const normalizedDeckName = typeof deckName === 'object' ? (deckName.name || deckName.toString()) : deckName.toString();
      html += `
        <div class="admin-deck-item">
          <div class="admin-deck-name">${escapeHtml(normalizedDeckName)}</div>
          <div class="admin-deck-actions">
            <button class="btn btn-outline btn-sm" data-action="edit" data-deck="${escapeHtml(normalizedDeckName)}">Edit</button>
            <button class="btn btn-outline btn-sm" data-action="delete" data-deck="${escapeHtml(normalizedDeckName)}">Delete</button>
          </div>
        </div>
      `;
    });

    if (userDecks.length === 0) {
      html = '<p>No user decks found. Create a new deck to get started.</p>';
    }

    deckListElement.innerHTML = html;

    // Add event listeners to action buttons
    deckListElement.querySelectorAll('[data-action="edit"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const deckName = this.getAttribute('data-deck');
        console.log(`Edit button clicked for deck: ${deckName}`);
        showDeckEditor(deckName);
      });
    });

    deckListElement.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const deckName = this.getAttribute('data-deck');
        console.log(`Delete button clicked for deck: ${deckName}`);
        deleteDeck(deckName);
      });
    });
  }
  
  /**
   * Create a new deck
   */
  function createNewDeck() {
    const newDeckNameInput = document.getElementById('newDeckName');
    if (!newDeckNameInput) {
        handleError("Deck name input field not found.");
        console.error('newDeckName input element not found');
        return;
    }
    const deckName = newDeckNameInput.value.trim();

    if (!deckName) {
      handleError('Deck name is required');
      return;
    }

    console.log(`Creating new deck: ${deckName}`);
    showLoadingIndicator();

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Create deck result:', result);
        
        if (result && result.success) {
          showSuccess(result.message || 'Deck created successfully');
          loadAdminDeckList(); // Reload the list to show the new deck
          newDeckNameInput.value = ''; // Clear input
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to create deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in createDeck call:', errorMsg);
        hideLoadingIndicator();
      })
      .createDeck(deckName);
  }

  /**
   * Delete a deck
   * @param {string} deckName - Name of the deck to delete
   */
  function deleteDeck(deckName) {
    if (!confirm(`Are you sure you want to delete the deck "${escapeHtml(deckName)}"? This action cannot be undone.`)) {
      return;
    }
    console.log(`Deleting deck: ${deckName}`);
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Delete deck result:', result);
        
        if (result && result.success) {
          showSuccess(result.message || 'Deck deleted successfully');
          loadAdminDeckList(); // Reload to reflect deletion
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to delete deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in deleteDeck call:', errorMsg);
        hideLoadingIndicator();
      })
      .deleteDeck(deckName);
  }

  // Store for cards being edited in a deck
  window.adminDeckCache = {
    cards: [],
    deckName: null
  };

  /**
   * Show deck editor (loads cards for a deck)
   * @param {string} deckName - Name of the deck to edit
   */
  function showDeckEditor(deckName) {
    console.log(`Loading deck editor for: ${deckName}`);
    showLoadingIndicator();
    window.adminDeckCache.deckName = deckName; // Store current deck name

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Get flashcards result:', result);
        
        if (result && result.success) {
          window.adminDeckCache.cards = result.cards || []; // Cache the cards
          console.log(`Loaded ${window.adminDeckCache.cards.length} cards for editing`);
          displayDeckEditorUI(deckName, window.adminDeckCache.cards);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to load flashcards for deck:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
          const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
          handleError(errorMsg);
          console.error('Error in getFlashcardsForDeck call:', errorMsg);
          hideLoadingIndicator();
      })
      .getFlashcardsForDeck(deckName); // This function needs to return card objects
  }

  /**
   * Display deck editor UI
   * @param {string} deckName - Name of the deck
   * @param {Array<Object>} cards - Array of flashcard objects
   */
  function displayDeckEditorUI(deckName, cards) {
    const decksTabContent = document.getElementById('decksTab'); // Target the main tab content area
    if (!decksTabContent) {
        showError("Deck management area not found.");
        console.error('decksTab element not found for editor UI');
        return;
    }

    let cardListHtml = '';
    if (!Array.isArray(cards) || cards.length === 0) {
      cardListHtml = '<p>No cards in this deck. Add a new card to get started.</p>';
    } else {
      cards.forEach(card => {
        // Ensure card properties are escaped for HTML safety
        const cardId = escapeHtml(card.id || card.FlashcardID || '');
        const sideA = escapeHtml(card.sideA || card.FlashcardSideA || '');
        const sideB = escapeHtml(card.sideB || card.FlashcardSideB || '');
        const sideC = escapeHtml(card.sideC || card.FlashcardSideC || '');
        let tags = '';
        
        if (Array.isArray(card.tags)) {
          tags = escapeHtml(card.tags.join(', '));
        } else if (typeof card.tags === 'string') {
          tags = escapeHtml(card.tags);
        } else if (card.Tags) {
          if (Array.isArray(card.Tags)) {
            tags = escapeHtml(card.Tags.join(', '));
          } else {
            tags = escapeHtml(String(card.Tags));
          }
        }
        
        cardListHtml += `
          <div class="admin-card-item" data-card-id="${cardId}">
            <div class="admin-card-content">
              <strong>Side A:</strong> ${sideA}<br>
              <strong>Side B:</strong> ${sideB}<br>
              ${sideC ? `<strong>Side C:</strong> ${sideC}<br>` : ''}
              ${tags ? `<strong>Tags:</strong> ${tags}` : ''}
            </div>
            <div class="admin-card-actions">
              <button class="btn btn-outline btn-sm" data-action="edit-card" data-card-id="${cardId}">Edit</button>
              <button class="btn btn-outline btn-sm" data-action="delete-card" data-card-id="${cardId}">Delete</button>
              <button class="btn btn-outline btn-sm" data-action="add-dictionary" data-card-id="${cardId}">Dictionary</button>
            </div>
          </div>
        `;
      });
    }

    decksTabContent.innerHTML = `
      <div class="card">
        <div class="card-title">Editing Deck: ${escapeHtml(deckName)}</div>
        <div class="form-actions">
          <button id="backToAdminDecks" class="btn btn-outline">Back to Decks</button>
          <button id="showAddCardFormBtn" class="btn">Add New Card</button>
        </div>
        
        <div id="addCardFormContainer" style="display: none; margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px;">
          <h3>Add New Card</h3>
          <div class="form-group">
            <label for="newCardSideA" class="form-label">Side A (Question)</label>
            <input type="text" id="newCardSideA" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="newCardSideB" class="form-label">Side B (Answer)</label>
            <input type="text" id="newCardSideB" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="newCardSideC" class="form-label">Side C (Additional Info)</label>
            <textarea id="newCardSideC" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="newCardTags" class="form-label">Tags (comma-separated)</label>
            <input type="text" id="newCardTags" class="form-control">
          </div>
          <div class="form-actions">
            <button id="submitNewCardBtn" class="btn btn-secondary">Save Card</button>
            <button id="cancelAddCardBtn" class="btn btn-outline">Cancel</button>
          </div>
        </div>
        
        <div class="admin-card-list" id="cardListDisplay">${cardListHtml}</div>
      </div>
    `;

    console.log('Deck editor UI rendered, attaching event listeners');
    
    // Add event listeners for this view
    document.getElementById('backToAdminDecks').addEventListener('click', loadAdminDeckList);
    
    document.getElementById('showAddCardFormBtn').addEventListener('click', function() {
      document.getElementById('addCardFormContainer').style.display = 'block';
      this.style.display = 'none'; // Hide the "Add New Card" button
    });
    
    document.getElementById('cancelAddCardBtn').addEventListener('click', function() {
      document.getElementById('addCardFormContainer').style.display = 'none';
      document.getElementById('newCardSideA').value = '';
      document.getElementById('newCardSideB').value = '';
      document.getElementById('newCardSideC').value = '';
      document.getElementById('newCardTags').value = '';
      document.getElementById('showAddCardFormBtn').style.display = 'inline-block'; // Show "Add New Card"
    });
    
    document.getElementById('submitNewCardBtn').addEventListener('click', function() {
      addNewCardToDeck(deckName);
    });
    
    // Card action buttons
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="edit-card"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        console.log(`Edit card button clicked for card ID: ${cardId}`);
        const cardToEdit = window.adminDeckCache.cards.find(c => (c.id === cardId) || (c.FlashcardID === cardId));
        if (cardToEdit) {
          showCardEditorForm(this.closest('.admin-card-item'), cardToEdit, deckName);
        } else {
          showError("Card data not found for editing.");
          console.error(`Card with ID ${cardId} not found in cached cards:`, window.adminDeckCache.cards);
        }
      });
    });
    
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="delete-card"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        console.log(`Delete card button clicked for card ID: ${cardId}`);
        deleteCardFromDeck(cardId, deckName);
      });
    });
    
    document.querySelectorAll('#cardListDisplay .admin-card-item [data-action="add-dictionary"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const cardId = this.getAttribute('data-card-id');
        console.log(`Dictionary button clicked for card ID: ${cardId}`);
        const cardForDict = window.adminDeckCache.cards.find(c => (c.id === cardId) || (c.FlashcardID === cardId));
        if (cardForDict) {
            handleDictionaryForCard(cardForDict, deckName);
        } else {
            showError("Card data not found for dictionary action.");
            console.error(`Card with ID ${cardId} not found in cached cards:`, window.adminDeckCache.cards);
        }
      });
    });
  }

  /**
   * Handle dictionary lookup for a specific card
   * @param {Object} card - The card object
   * @param {string} deckName - The name of the current deck
   */
  function handleDictionaryForCard(card, deckName) {
    // Switch to dictionary tab
    const dictionaryTabButton = document.querySelector('.admin-tab[data-tab="dictionary"]');
    if (dictionaryTabButton) {
        console.log('Switching to dictionary tab');
        dictionaryTabButton.click(); // This will also make the tab content visible
    } else {
        showError("Dictionary tab not found.");
        console.error('Dictionary tab button not found in DOM');
        return;
    }

    // Pre-fill and trigger lookup
    // Wait a moment for the tab content to be potentially rendered and visible
    setTimeout(() => {
        const dictionaryWordInput = document.getElementById('dictionaryWord');
        const lookupBtn = document.getElementById('lookupWordBtn');
        const targetDeckDropdown = document.getElementById('targetDeck');

        if (!dictionaryWordInput || !lookupBtn || !targetDeckDropdown) {
            showError("Dictionary UI elements not found. Ensure the template is loaded.");
            console.error('Dictionary UI elements not found after tab switch');
            return;
        }

        // Use Side A as the default lookup term. Allow user to change if needed.
        // Taking the first significant word or a short phrase might be better than the whole Side A.
        let wordToLookup = (card.sideA || card.FlashcardSideA || '').trim();
        if (wordToLookup) {
            // Simple strategy: take first few words, or up to a certain length
            const words = wordToLookup.split(/\s+/);
            wordToLookup = words.slice(0, 3).join(' '); // e.g., first 3 words
             // Or, if it's a single long word, just use that.
            if (words.length === 1 && words[0].length > 15) {
                 wordToLookup = words[0];
            }
        }
        
        console.log(`Pre-filling dictionary with word: "${wordToLookup}" for card: ${card.id || card.FlashcardID}`);
        dictionaryWordInput.value = wordToLookup || '';

        // Auto-select deck and card
        // populateDeckDropdown is called by initDictionaryLookup, so it should be populated.
        targetDeckDropdown.value = deckName;
        // Trigger change to load cards for this deck
        targetDeckDropdown.dispatchEvent(new Event('change')); 

        // After cards are loaded (another async step), select the card
        // This needs to be robust. `loadCardsForDeck` should ideally have a callback.
        // For now, using a timeout as a temporary measure.
        console.log('Setting up interval to check when cards are loaded');
        const intervalCheck = setInterval(function() {
            const targetCardDropdown = document.getElementById('targetCard');
            if (targetCardDropdown && targetCardDropdown.options.length > 1) { // Wait for options
                console.log(`Card dropdown populated with ${targetCardDropdown.options.length} options`);
                
                // Try setting the dropdown to the card ID
                const cardId = card.id || card.FlashcardID;
                targetCardDropdown.value = cardId;
                
                if (targetCardDropdown.value === cardId) { // Check if selection was successful
                    console.log(`Successfully selected card ${cardId} in dropdown`);
                    clearInterval(intervalCheck);
                    if (wordToLookup && lookupBtn) {
                        console.log('Triggering dictionary lookup');
                        lookupBtn.click(); // Trigger lookup
                    }
                } else {
                    console.log(`Failed to select card ${cardId}, dropdown value is: ${targetCardDropdown.value}`);
                }
            }
        }, 200); // Check every 200ms

        setTimeout(() => {
            clearInterval(intervalCheck);
            console.log('Dictionary card selection timeout reached');
        }, 3000); // Timeout for safety

    }, 100); // Small delay for tab switch
  }


  /**
   * Add a new card to a deck
   * @param {string} deckName - Name of the deck
   */
  function addNewCardToDeck(deckName) {
    const sideA = document.getElementById('newCardSideA').value.trim();
    const sideB = document.getElementById('newCardSideB').value.trim();
    const sideC = document.getElementById('newCardSideC').value.trim();
    const tags = document.getElementById('newCardTags').value.trim();

    if (!sideA || !sideB) {
      handleError('Side A (Question) and Side B (Answer) are required.');
      return;
    }

    console.log(`Adding new card to deck: ${deckName}`);
    showLoadingIndicator();
    const cardData = { sideA, sideB, sideC, tags };

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Add flashcard result:', result);
        
        if (result && result.success) {
          showSuccess('Card added successfully!');
          // Hide form and reset
          document.getElementById('addCardFormContainer').style.display = 'none';
          document.getElementById('newCardSideA').value = '';
          document.getElementById('newCardSideB').value = '';
          document.getElementById('newCardSideC').value = '';
          document.getElementById('newCardTags').value = '';
          document.getElementById('showAddCardFormBtn').style.display = 'inline-block';
          
          // Reload deck editor to show the new card
          showDeckEditor(deckName); 
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to add flashcard:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in addFlashcard call:', errorMsg);
        hideLoadingIndicator();
      })
      .addFlashcard(deckName, cardData);
  }

  /**
   * Show card editor form inline
   * @param {Element} cardElement - The .admin-card-item element
   * @param {Object} card - The card object (with id, sideA, sideB, sideC, tags)
   * @param {string} deckName - Name of the deck
   */
  function showCardEditorForm(cardElement, card, deckName) {
    // Store original content to restore on cancel
    const originalContentHtml = cardElement.innerHTML;
    const cardId = card.id || card.FlashcardID || '';
    
    // Normalize card properties to handle both naming conventions
    const sideA = card.sideA || card.FlashcardSideA || '';
    const sideB = card.sideB || card.FlashcardSideB || '';
    const sideC = card.sideC || card.FlashcardSideC || '';
    
    // Handle tags which could be string or array
    let tagsValue = '';
    if (Array.isArray(card.tags)) {
      tagsValue = card.tags.join(', ');
    } else if (typeof card.tags === 'string') {
      tagsValue = card.tags;
    } else if (card.Tags) {
      if (Array.isArray(card.Tags)) {
        tagsValue = card.Tags.join(', ');
      } else {
        tagsValue = String(card.Tags);
      }
    }
    
    console.log(`Showing editor form for card: ${cardId}`);

    cardElement.innerHTML = `
      <div class="card-edit-form" style="background-color: #f9f9f9; padding: 10px; border-radius: 4px;">
        <h4>Edit Card (ID: ${escapeHtml(cardId)})</h4>
        <div class="form-group">
          <label for="editCardSideA-${cardId}" class="form-label">Side A</label>
          <input type="text" id="editCardSideA-${cardId}" class="form-control" value="${escapeHtml(sideA)}" required>
        </div>
        <div class="form-group">
          <label for="editCardSideB-${cardId}" class="form-label">Side B</label>
          <input type="text" id="editCardSideB-${cardId}" class="form-control" value="${escapeHtml(sideB)}" required>
        </div>
        <div class="form-group">
          <label for="editCardSideC-${cardId}" class="form-label">Side C</label>
          <textarea id="editCardSideC-${cardId}" class="form-control" rows="3">${escapeHtml(sideC)}</textarea>
        </div>
        <div class="form-group">
          <label for="editCardTags-${cardId}" class="form-label">Tags</label>
          <input type="text" id="editCardTags-${cardId}" class="form-control" value="${escapeHtml(tagsValue)}">
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary btn-sm" data-action="save-edit" data-card-id="${cardId}">Save</button>
          <button class="btn btn-outline btn-sm" data-action="cancel-edit">Cancel</button>
        </div>
      </div>
    `;

    cardElement.querySelector('[data-action="save-edit"]').addEventListener('click', function() {
      updateEditedCard(cardId, deckName);
    });

    cardElement.querySelector('[data-action="cancel-edit"]').addEventListener('click', function() {
      cardElement.innerHTML = originalContentHtml; // Restore original
      // Re-attach listeners for the restored buttons
      const restoredEditBtn = cardElement.querySelector('[data-action="edit-card"]');
      if (restoredEditBtn) {
          restoredEditBtn.addEventListener('click', () => showCardEditorForm(cardElement, card, deckName));
      }
      const restoredDeleteBtn = cardElement.querySelector('[data-action="delete-card"]');
      if (restoredDeleteBtn) {
          restoredDeleteBtn.addEventListener('click', () => deleteCardFromDeck(cardId, deckName));
      }
      const restoredDictBtn = cardElement.querySelector('[data-action="add-dictionary"]');
      if (restoredDictBtn) {
          restoredDictBtn.addEventListener('click', () => handleDictionaryForCard(card, deckName));
      }
    });
  }

  /**
   * Update an edited card
   * @param {string} cardId - ID of the card
   * @param {string} deckName - Name of the deck
   */
  function updateEditedCard(cardId, deckName) {
    const sideA = document.getElementById(`editCardSideA-${cardId}`).value.trim();
    const sideB = document.getElementById(`editCardSideB-${cardId}`).value.trim();
    const sideC = document.getElementById(`editCardSideC-${cardId}`).value.trim();
    const tags = document.getElementById(`editCardTags-${cardId}`).value.trim();

    if (!sideA || !sideB) {
      handleError('Side A and Side B are required.');
      return;
    }
    console.log(`Updating card ${cardId} in deck ${deckName}`);
    showLoadingIndicator();
    const cardData = { sideA, sideB, sideC, tags };

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Update flashcard result:', result);
        
        if (result && result.success) {
          showSuccess('Card updated successfully!');
          showDeckEditor(deckName); // Reload the deck editor view
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to update flashcard:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in updateFlashcard call:', errorMsg);
        hideLoadingIndicator();
      })
      .updateFlashcard(deckName, cardId, cardData);
  }

  /**
   * Delete a card from a deck
   * @param {string} cardId - ID of the card
   * @param {string} deckName - Name of the deck
   */
  function deleteCardFromDeck(cardId, deckName) {
    if (!confirm(`Are you sure you want to delete card ID "${escapeHtml(cardId)}"? This cannot be undone.`)) {
      return;
    }
    console.log(`Deleting card ${cardId} from deck ${deckName}`);
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Delete flashcard result:', result);
        
        if (result && result.success) {
          showSuccess('Card deleted successfully!');
          showDeckEditor(deckName); // Reload
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          console.error('Failed to delete flashcard:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        console.error('Error in deleteFlashcard call:', errorMsg);
        hideLoadingIndicator();
      })
      .deleteFlashcard(deckName, cardId);
  }

  /**
   * Load user list for admin panel
   */
  function loadUserList() {
    showLoadingIndicator();
    console.log('Loading user list for admin panel');
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Get users result:', result);
        
        if (result && result.success) {
          displayUserList(result.users || []);
        } else {
          const errorMsg = result ? result.message : 'Unknown error occurred';
          handleError(errorMsg);
          const userListTbody = document.querySelector('#userList table tbody');
          if (userListTbody) {
            userListTbody.innerHTML = `<tr><td colspan="5">Error loading users: ${escapeHtml(errorMsg)}</td></tr>`;
          }
          console.error('Failed to load users:', errorMsg);
        }
        hideLoadingIndicator();
      })
      .withFailureHandler(function(err) {
        const errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Unknown error');
        handleError(errorMsg);
        const userListTbody = document.querySelector('#userList table tbody');
        if (userListTbody) {
          userListTbody.innerHTML = `<tr><td colspan="5">Error loading users: ${escapeHtml(errorMsg)}</td></tr>`;
        }
        console.error('Error in getUsers call:', errorMsg);
        hideLoadingIndicator();
      })
      .getUsers();
  }

  /**
   * Display user list in admin panel
   * @param {Array<Object>} users - Array of user objects
   */
  function displayUserList(users) {
    const userListTableBody = document.querySelector('#userList table tbody');
    if (!userListTableBody) {
      console.error('User list table body not found.');
      return;
    }

    let html = '';
    if (!Array.isArray(users) || users.length === 0) {
      html = '<tr><td colspan="5">No users found.</td></tr>';
    } else {
      console.log(`Displaying ${users.length} users in admin panel`);
      
      users.forEach(user => {
        const isAdmin = user.IsAdmin === 'TRUE' || user.IsAdmin === true;
        const lastLogin = user.LastLogin ? new Date(user.LastLogin).toLocaleString() : 'Never';
        html += `
          <tr>
            <td>${escapeHtml(user.StudentFirst || '')} ${escapeHtml(user.StudentLast || '')}</td>
            <td>${escapeHtml(user.UserName || '')}</td>
            <td>${isAdmin ? 'Admin' : 'Student'}</td>
            <td>${escapeHtml(lastLogin)}</td>
            <td>
              <button class="btn btn-outline btn-sm" data-action="view-progress" data-username="${escapeHtml(user.UserName || '')}" disabled>Progress</button>
              <!-- Add other user actions here, e.g., edit user, reset password -->
            </td>
          </tr>
        `;
      });
    }
    userListTableBody.innerHTML = html;

    // Add event listeners for any new buttons (currently 'view-progress' is disabled)
    userListTableBody.querySelectorAll('[data-action="view-progress"]').forEach(btn => {
      if (!btn.disabled) {
        btn.addEventListener('click', function() {
          const username = this.getAttribute('data-username');
          console.log(`View progress button clicked for user: ${username}`);
          // TODO: Implement view progress functionality
          alert('View progress for ' + username + ' (not implemented yet)');
        });
      }
    });
  }
</script>