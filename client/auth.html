<script>
  /**
   * Handle login form submission
   * 
   * @param {Event} event - Form submit event
   */
  function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!username) {
      handleError('Username is required');
      return;
    }
    
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Update app state
          window.app.isLoggedIn = true;
          window.app.isAdmin = result.user.isAdmin;
          window.app.userName = result.user.userName;
          
          // Show user info
          const userInfo = document.getElementById('userInfo');
          userInfo.style.display = 'flex';
          userInfo.querySelector('span').textContent = `Welcome, ${result.user.userName}`;
          
          // Show admin button if applicable
          const adminBtn = document.getElementById('adminPanelBtn');
          if (adminBtn) {
            adminBtn.style.display = result.user.isAdmin ? 'block' : 'none';
          }
          
          // Load deck list
          loadDeckList();
          
          // Show success message
          showSuccess('Login successful');
        } else if (result.needsInit) {
          // App needs initialization
          showInitForm();
        } else {
          // Login failed
          handleError(result.message);
        }
        
        hideLoadingIndicator();
      })
      .withFailureHandler(handleError)
      .authenticateUser(username, password);
  }
  
  /**
   * Toggle password visibility
   */
  function togglePasswordVisibility() {
    const passwordInput = document.getElementById('password');
    const icon = document.getElementById('passwordToggle');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.textContent = 'visibility_off';
    } else {
      passwordInput.type = 'password';
      icon.textContent = 'visibility';
    }
  }
  
  /**
   * Show app initialization form
   */
  function showInitForm() {
    const contentArea = document.getElementById('appContent');
    
    contentArea.innerHTML = `
      <div class="card">
        <div class="card-title">Initialize Flashcard App</div>
        <p>This app needs to be initialized before first use.</p>
        <form id="initForm" class="form">
          <div class="form-group">
            <label for="databaseName" class="form-label">Database Name</label>
            <input type="text" id="databaseName" class="form-control" value="Flashcard App Database" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn">Initialize App</button>
          </div>
        </form>
      </div>
    `;
    
    // Add event listener to the form
    document.getElementById('initForm').addEventListener('submit', handleInitApp);
  }
  
  /**
   * Handle app initialization
   * 
   * @param {Event} event - Form submit event
   */
  function handleInitApp(event) {
    event.preventDefault();
    
    const databaseName = document.getElementById('databaseName').value;
    
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showSuccess('App initialized successfully');
          showLoginForm();
        } else {
          handleError(result.message);
        }
        
        hideLoadingIndicator();
      })
      .withFailureHandler(handleError)
      .initializeApp({ databaseName: databaseName });
  }
</script>