<script>
  // ... (loadDeck, displayFlashcardView, setupAudioButtons, hasValidContent remain largely the same as Phase 2) ...
  // Make sure setupAudioButtons is robust from previous phase.

  // Update the setupAudioButtons function in your flashcards.js file
  function setupAudioButtons(containerSelector) {
      console.log(`[setupAudioButtons] Attempting to set up for container: ${containerSelector}`);
      
      // Find the container
      const container = document.querySelector(containerSelector);
      if (!container) {
          console.error(`[setupAudioButtons] Container '${containerSelector}' not found`);
          return;
      }
      
      // Find all audio buttons within the container
      const buttons = container.querySelectorAll('.audio-play-btn');
      console.log(`[setupAudioButtons] Found ${buttons.length} '.audio-play-btn' elements.`);
      
      // Attach click event to each button
      buttons.forEach((button, index) => {
          console.log(`[setupAudioButtons] Processing button #${index+1} (ID: ${button.id})`);
          
          // Find the corresponding audio element
          const audioElement = button.nextElementSibling;
          
          if (!audioElement || audioElement.tagName !== 'AUDIO') {
              console.error(`[setupAudioButtons] No audio element found for button (ID: ${button.id})`);
              return;
          }
          
          console.log(`[setupAudioButtons] Found <audio> element for button (ID: ${button.id}): with src: ${audioElement.querySelector('source').src.substring(0, 100)}...`);
          
          // Remove any existing event listeners to prevent duplicates
          button.replaceWith(button.cloneNode(true));
          const newButton = document.getElementById(button.id);
          
          // Add click event listener to play/pause audio
          newButton.addEventListener('click', function() {
              console.log(`[AudioButton] Button clicked: ${this.id}`);
              
              // Get the audio element again since we replaced the button
              const audio = this.nextElementSibling;
              
              if (audio.paused) {
                  // Stop all other audio first
                  document.querySelectorAll('audio').forEach(a => {
                      if (a !== audio && !a.paused) {
                          a.pause();
                          a.currentTime = 0;
                      }
                  });
                  
                  // Play this audio
                  audio.play()
                      .then(() => {
                          console.log(`[AudioButton] Audio playing for: ${this.id}`);
                          this.innerHTML = '<i class="fas fa-pause"></i> Pause';
                      })
                      .catch(err => {
                          console.error(`[AudioButton] Error playing audio: ${err.message}`);
                      });
              } else {
                  // Pause this audio
                  audio.pause();
                  audio.currentTime = 0;
                  this.innerHTML = '<i class="fas fa-play"></i> Play Audio';
                  console.log(`[AudioButton] Audio paused for: ${this.id}`);
              }
          });
          
          console.log(`[setupAudioButtons] Event listeners attached to button (ID: ${newButton.id}).`);
      });
  }

  // Update the displayFlashcard function to better handle media content
  function displayFlashcard(index, cards) {
      const card = cards[index];
      console.log(`flashcards.html: displayFlashcard - Called for index: ${index}, CardID: ${card.FlashcardID}`);
      
      // Clear any existing audio elements
      document.querySelectorAll('audio').forEach(audio => {
          audio.pause();
          audio.currentTime = 0;
      });
      
      // Set up the front of the card (Side A)
      document.getElementById('flashcard-front').innerHTML = `
          <div class="flashcard-content">
              <div class="flashcard-text">${card.SideA || ''}</div>
          </div>
      `;
      
      // Process Side B
      let sideB = card.SideB || '';
      let sideBHtml = '';
      
      if (sideB.includes('[IMAGE:') || sideB.includes('[AUDIO:')) {
          console.log(`flashcards.html: displayFlashcard - Side B for card ${card.FlashcardID} has media. Sending to renderDictionaryContent. Content: "${sideB.substring(0, 100)}..."`);
          sideBHtml = renderDictionaryContent(sideB, 'B');
          console.log(`flashcards.html: displayFlashcard -> render Success (Side B) for card ${card.FlashcardID} - Received HTML: "${sideBHtml.substring(0, 100)}..."`);
      } else {
          sideBHtml = `<div class="flashcard-text">${sideB}</div>`;
      }
      
      // Process Side C
      let sideC = card.SideC || '';
      let sideCHtml = '';
      
      if (sideC.includes('[IMAGE:') || sideC.includes('[AUDIO:')) {
          console.log(`flashcards.html: displayFlashcard - Side C for card ${card.FlashcardID} has media. Sending to renderDictionaryContent. Content: "${sideC.substring(0, 100)}..."`);
          sideCHtml = renderDictionaryContent(sideC, 'C');
          console.log(`flashcards.html: displayFlashcard -> render Success (Side C) for card ${card.FlashcardID} - Received HTML: "${sideCHtml.substring(0, 100)}..."`);
      } else {
          sideCHtml = `<div class="flashcard-text">${sideC}</div>`;
      }
      
      // Set back content
      document.getElementById('flashcard-back').innerHTML = `
          <div class="flashcard-content">
              ${sideBHtml}
              <div class="side-separator"></div>
              ${sideCHtml}
          </div>
      `;
      
      // Set up audio buttons after DOM has been updated
      console.log("[displayFlashcard -> checkAndSetupAllAudio] Both sides processed. Setting up audio buttons.");
      setTimeout(() => {
          setupAudioButtons('#flashcard-back');
      }, 100);
      
      // Show the current card in the counter
      document.getElementById('card-count').textContent = `Card ${index + 1} of ${cards.length}`;
      
      // Update current card index
      currentCardIndex = index;
  }
  
  // ... (rateCard, showDeckComplete functions remain the same as Phase 2) ...
  // loadDeck, displayFlashcardView also remain same as Phase 2 (other than new logs within displayFlashcard)

  /**
   * Load a specific deck
   * @param {string} deckName - Name of the deck to load
   */
  function loadDeck(deckName) {
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator(); 
        if (result && result.success) { 
          console.log('[loadDeck] Success. Server result (first card snippet if exists):', result.cards && result.cards.length > 0 ? JSON.parse(JSON.stringify(result.cards[0])) : "No cards or empty deck");
          window.app.currentDeck = deckName;
          displayFlashcardView(result);
        } else {
          const errorMsg = result ? result.message : `Failed to load deck "${escapeHtml(deckName)}".`;
          console.error('[loadDeck] Error or unexpected result from server:', result);
          handleError(errorMsg);
        }
      })
      .withFailureHandler(function(err) {
        const errorDetail = err && err.message ? err.message : 'Unknown error';
        console.error('[loadDeck] Failure handler triggered:', err);
        handleError(`An error occurred while loading deck "${escapeHtml(deckName)}": ${errorDetail}`);
      })
      .getFlashcardsForDeck(deckName);
  }

  /**
   * Display the flashcard study view
   * @param {Object} deckData - The deck data with cards (deckData.cards)
   */
  function displayFlashcardView(deckData) {
    console.log('[displayFlashcardView] Called with deck data. Cards count:', deckData && deckData.cards ? deckData.cards.length : 'N/A');
    if (!deckData || !deckData.cards || deckData.cards.length === 0) {
      const contentArea = document.getElementById('appContent');
      contentArea.innerHTML = `<div class="card"><div class="card-title">No Cards Available</div><p>This deck ("${escapeHtml(window.app.currentDeck || 'Unknown Deck')}") doesn't have any cards yet or cards failed to load.</p><div class="form-actions"><button id="backToDeckList" class="btn btn-outline">Back to Decks</button></div></div>`;
      const backButton = document.getElementById('backToDeckList');
      if (backButton) backButton.addEventListener('click', loadDeckList);
      return;
    }
    window.app.currentCards = deckData.cards;
    window.app.currentCardIndex = 0;
    displayFlashcard(deckData.cards, 0);
  }
  
  function hasValidContent(content) {
    if (content === null || content === undefined) return false;
    if (typeof content !== 'string') return false; 
    const trimmedContent = content.trim();
    if (trimmedContent === '') return false; 
    return true; 
  }

  function rateCard(cardId, rating, cards, index) {
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        if (result && result.success) {
          displayFlashcard(cards, index + 1);
        } else {
          handleError(result ? result.message : 'Failed to record card rating.');
        }
      })
      .withFailureHandler(function(err){
        handleError(err.message || 'An error occurred while rating the card.');
      })
      .recordCardRating(window.app.currentDeck, cardId, rating);
  }
  
  function showDeckComplete() {
    const contentArea = document.getElementById('appContent');
    contentArea.innerHTML = `<div class="card"><div class="card-title">Well done!</div><p>You have completed studying deck: "${escapeHtml(window.app.currentDeck || 'this deck')}".</p><div class="form-actions" style="margin-top: 20px;"><button id="backToDeckListComplete" class="btn">Back to Decks</button><button id="restartDeckComplete" class="btn btn-outline">Study Again</button></div></div>`;
    const backButton = document.getElementById('backToDeckListComplete');
    if (backButton) backButton.addEventListener('click', loadDeckList);
    const restartButton = document.getElementById('restartDeckComplete');
    if (restartButton) restartButton.addEventListener('click', function() {
      if (window.app.currentDeck) loadDeck(window.app.currentDeck);
      else loadDeckList();
    });
  }
</script>