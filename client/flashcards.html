<script>
  /**
   * Load a specific deck
   * 
   * @param {string} deckName - Name of the deck to load
   */
  function loadDeck(deckName) {
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator(); // Hide indicator once response is received

        if (result && result.success) { // Check if result is truthy AND has success property
          console.log('[loadDeck] Success. Server result:', result);
          if (result.cards && result.cards.length > 0) {
            console.log('[loadDeck] First card received from server:', JSON.parse(JSON.stringify(result.cards[0])));
          } else {
            console.log('[loadDeck] No cards received or cards array is empty.');
          }
          
          // Store deck data
          window.app.currentDeck = deckName;
          
          // Show the flashcard view
          displayFlashcardView(result);
        } else {
          // Handle error or unexpected result
          const errorMsg = result ? result.message : `Failed to load deck "${escapeHtml(deckName)}". Received an unexpected or null response from the server.`;
          console.error('[loadDeck] Error or unexpected result:', result);
          handleError(errorMsg);
        }
      })
      .withFailureHandler(function(err) {
        // handleError in main.html already calls hideLoadingIndicator()
        const errorDetail = err && err.message ? err.message : 'Unknown error';
        console.error('[loadDeck] Failure handler triggered:', err);
        handleError(`An error occurred while loading deck "${escapeHtml(deckName)}": ${errorDetail}`);
      })
      .getFlashcardsForDeck(deckName);
  }

  /**
   * Display the flashcard study view
   * 
   * @param {Object} deckData - The deck data with cards
   */
  function displayFlashcardView(deckData) {
    console.log('[displayFlashcardView] Called with deck data:', deckData);
    
    if (!deckData || !deckData.cards || deckData.cards.length === 0) {
      const contentArea = document.getElementById('appContent');
      contentArea.innerHTML = `
        <div class="card">
          <div class="card-title">No Cards Available</div>
          <p>This deck doesn't have any cards yet. Please contact an administrator to add cards to this deck.</p>
          <div class="form-actions">
            <button id="backToDeckList" class="btn btn-outline">Back to Decks</button>
          </div>
        </div>
      `;
      
      const backButton = document.getElementById('backToDeckList');
      if (backButton) backButton.addEventListener('click', loadDeckList);
      return;
    }
    
    // Store cards in the app state
    window.app.currentCards = deckData.cards;
    window.app.currentCardIndex = 0;
    
    // Display the first card
    displayFlashcard(deckData.cards, 0);
  }

  /**
   * Sets up the custom audio play buttons
   * 
   * @param {Element} container - Container element with audio buttons
   */
  function setupAudioButtons(container) {
    const audioButtons = container.querySelectorAll('.audio-play-btn');
    
    audioButtons.forEach(button => {
      const audio = button.querySelector('audio');
      if (!audio) return;
      
      // Toggle play/pause icon
      button.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // Stop all other playing audio
        document.querySelectorAll('.audio-play-btn.playing').forEach(btn => {
          if (btn !== this) {
            const otherAudio = btn.querySelector('audio');
            if (otherAudio) {
              otherAudio.pause();
              otherAudio.currentTime = 0;
            }
            btn.classList.remove('playing');
            btn.querySelector('.material-icons').textContent = 'play_arrow';
          }
        });
        
        if (audio.paused) {
          audio.play();
          this.classList.add('playing');
          this.querySelector('.material-icons').textContent = 'pause';
        } else {
          audio.pause();
          audio.currentTime = 0;
          this.classList.remove('playing');
          this.querySelector('.material-icons').textContent = 'play_arrow';
        }
      });
      
      // Reset button when audio ends
      audio.addEventListener('ended', function() {
        button.classList.remove('playing');
        button.querySelector('.material-icons').textContent = 'play_arrow';
      });
    });
  }
  
  /**
   * Helper function to check if content has valid displayable content
   * 
   * @param {string} content - Content to check
   * @return {boolean} True if content has valid displayable content
   */
  function hasValidContent(content) {
    if (!content) return false;
    if (typeof content !== 'string') return false;
    
    // If it's just whitespace and no media tags, consider it empty
    if (!content.includes('[IMAGE:') && !content.includes('[AUDIO:') && content.trim() === '') {
      return false;
    }
    
    return true;
  }
  
  /**
   * Display a specific flashcard
   * 
   * @param {Array} cards - Array of cards
   * @param {number} index - Index of the card to display
   */
  function displayFlashcard(cards, index) {
    console.log('[displayFlashcard] Called with index:', index, 'Total cards in current list:', cards ? cards.length : 'N/A');
    
    if (!cards || index >= cards.length) { // Added !cards check
      console.log('[displayFlashcard] End of deck reached or invalid card array.');
      // End of deck reached
      showDeckComplete();
      return;
    }
    
    const card = cards[index];
    console.log('[displayFlashcard] Current card object:', JSON.parse(JSON.stringify(card))); // Deep copy for logging to avoid later modifications affecting log
    console.log('[displayFlashcard] card.FlashcardSideA:', card.FlashcardSideA, '(type: ' + typeof card.FlashcardSideA + ')');
    console.log('[displayFlashcard] card.FlashcardSideB:', card.FlashcardSideB, '(type: ' + typeof card.FlashcardSideB + ')');
    console.log('[displayFlashcard] card.FlashcardSideC:', card.FlashcardSideC, '(type: ' + typeof card.FlashcardSideC + ')');
    console.log('[displayFlashcard] card.id (should be FlashcardID):', card.id, '(type: ' + typeof card.id + ')');

    const contentArea = document.getElementById('appContent');
    
    // Process dictionary content in FlashcardSideC if present
    let sideCContent = card.FlashcardSideC || '';
    console.log('[displayFlashcard] Initial sideCContent for display:', sideCContent);
    
    // Parse study configuration
    let studyConfig = { showSideB: true, showSideC: true }; // Default configuration
    if (card.StudyConfig) {
      try {
        const parsedConfig = JSON.parse(card.StudyConfig);
        studyConfig = { ...studyConfig, ...parsedConfig };
      } catch (e) {
        console.error('[displayFlashcard] Failed to parse study configuration:', e);
      }
    }
    
    contentArea.innerHTML = `
      <div class="flashcard-container">
        <div class="deck-info">
          <h2>${escapeHtml(window.app.currentDeck)}</h2>
          <div class="progress">Card ${index + 1} of ${cards.length}</div>
        </div>
        
        <div class="flashcard" id="currentCard">
          <div class="flashcard-front">
            <div class="flashcard-content">${escapeHtml(card.FlashcardSideA)}</div>
            <div class="flashcard-helper">Click to flip</div>
          </div>
          <div class="flashcard-back">
            ${(studyConfig.showSideB && hasValidContent(card.FlashcardSideB)) ? 
              `<div class="flashcard-content">${escapeHtml(card.FlashcardSideB)}</div>` : ''}
            ${(studyConfig.showSideC && hasValidContent(card.FlashcardSideC)) ? 
              `<div class="flashcard-secondary" id="flashcardSideCContent">${escapeHtml(sideCContent)}</div>` : ''}
          </div>
        </div>
        
        <div class="rating-buttons" style="display: none;" id="ratingButtons">
          <button class="rating-btn rating-btn-again" data-rating="0">
            <span class="material-icons">sentiment_very_dissatisfied</span>
            <span>Again</span>
          </button>
          <button class="rating-btn rating-btn-hard" data-rating="1">
            <span class="material-icons">sentiment_dissatisfied</span>
            <span>Hard</span>
          </button>
          <button class="rating-btn rating-btn-good" data-rating="2">
            <span class="material-icons">sentiment_satisfied</span>
            <span>Good</span>
          </button>
          <button class="rating-btn rating-btn-easy" data-rating="3">
            <span class="material-icons">sentiment_very_satisfied</span>
            <span>Easy</span>
          </button>
        </div>
        
        <div class="flashcard-controls">
          <button id="backToDeckList" class="btn btn-outline">Back to Decks</button>
        </div>
      </div>
    `;
    
    // Process dictionary content in both Side B and Side C if present
    if ((card.FlashcardSideB && (card.FlashcardSideB.includes('[AUDIO:') || card.FlashcardSideB.includes('[IMAGE:'))) ||
        (card.FlashcardSideC && (card.FlashcardSideC.includes('[AUDIO:') || card.FlashcardSideC.includes('[IMAGE:')))) {
      
      console.log('[displayFlashcard] Dictionary content found in flashcard sides. Processing content.');
      
      // Process Side B content
      if (studyConfig.showSideB && card.FlashcardSideB && (card.FlashcardSideB.includes('[AUDIO:') || card.FlashcardSideB.includes('[IMAGE:'))) {
        google.script.run
          .withSuccessHandler(function(processedContent) {
            console.log('[displayFlashcard] renderDictionaryContent success for Side B:', processedContent);
            // Update the card back main content
            const mainContentElement = document.querySelector('.flashcard-back .flashcard-content');
            if (mainContentElement) {
              mainContentElement.innerHTML = processedContent; // Processed content is already HTML
            }
          })
          .withFailureHandler(function(err){
            console.error("[displayFlashcard] Failed to render Side B dictionary content:", err);
          })
          .renderDictionaryContent(card.FlashcardSideB);
      }
      
      // Process Side C content
      if (studyConfig.showSideC && card.FlashcardSideC && (card.FlashcardSideC.includes('[AUDIO:') || card.FlashcardSideC.includes('[IMAGE:'))) {
        google.script.run
          .withSuccessHandler(function(processedContent) {
            console.log('[displayFlashcard] renderDictionaryContent success for Side C:', processedContent);
            // Update the card back secondary content
            const secondaryContentElement = document.getElementById('flashcardSideCContent');
            if (secondaryContentElement) {
              secondaryContentElement.innerHTML = processedContent; // Processed content is already HTML
            }
          })
          .withFailureHandler(function(err){
            console.error("[displayFlashcard] Failed to render Side C dictionary content:", err);
          })
          .renderDictionaryContent(card.FlashcardSideC);
      }
    }
    
    // Add event listeners
    const flashcardElement = document.getElementById('currentCard'); // Renamed to avoid conflict
    if (flashcardElement) {
      flashcardElement.addEventListener('click', function() {
        this.classList.toggle('flipped');
        
        // Show rating buttons when card is flipped to back
        const ratingButtons = document.getElementById('ratingButtons');
        if (ratingButtons) { // Check if element exists
            if (this.classList.contains('flipped')) {
                ratingButtons.style.display = 'flex';
            } else {
                ratingButtons.style.display = 'none';
            }
        }
      });
    }
    
    // Rating buttons
    document.querySelectorAll('.rating-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent card from flipping back
        const rating = parseInt(this.getAttribute('data-rating'));
        rateCard(card.id, rating, cards, index); // Ensure card.id is correct here
      });
    });
    
    // Back button
    const backToDeckListButton = document.getElementById('backToDeckList');
    if (backToDeckListButton) { // Check if element exists
        backToDeckListButton.addEventListener('click', loadDeckList);
    }
  }
  
  /**
   * Rate a flashcard and move to the next one
   * 
   * @param {string} cardId - ID of the card
   * @param {number} rating - Rating value (0-3)
   * @param {Array} cards - Array of cards
   * @param {number} index - Current card index
   */
  function rateCard(cardId, rating, cards, index) {
    showLoadingIndicator();
    console.log('[rateCard] Rating cardId:', cardId, 'with rating:', rating);
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator(); // Hide indicator after server response
        if (result && result.success) { // Check result
          console.log('[rateCard] Successfully rated card. Server response:', result);
          // Move to the next card
          displayFlashcard(cards, index + 1);
        } else {
          console.error('[rateCard] Failed to record card rating. Server response:', result);
          handleError(result ? result.message : 'Failed to record card rating.');
        }
      })
      .withFailureHandler(function(err){ // Add failure handler
        // handleError will hide indicator
        console.error('[rateCard] Error occurred while rating card:', err);
        handleError(err.message || 'An error occurred while rating the card.');
      })
      .recordCardRating(window.app.currentDeck, cardId, rating);
  }
  
  /**
   * Show deck completion screen
   */
  function showDeckComplete() {
    const contentArea = document.getElementById('appContent');
    console.log('[showDeckComplete] Displaying deck completion screen.');
    
    contentArea.innerHTML = `
      <div class="card">
        <div class="card-title">Well done!</div>
        <p>You have completed studying this deck.</p>
        <div class="form-actions" style="margin-top: 20px;">
          <button id="backToDeckList" class="btn">Back to Decks</button>
          <button id="restartDeck" class="btn btn-outline">Study Again</button>
        </div>
      </div>
    `;
    
    // Add event listeners
    const backButton = document.getElementById('backToDeckList');
    if (backButton) backButton.addEventListener('click', loadDeckList);
    
    const restartButton = document.getElementById('restartDeck');
    if (restartButton) restartButton.addEventListener('click', function() {
      if (window.app.currentDeck) { // Ensure currentDeck is set
        console.log('[showDeckComplete] Restarting deck:', window.app.currentDeck);
        loadDeck(window.app.currentDeck);
      } else {
        console.warn('[showDeckComplete] currentDeck not set, loading deck list as fallback.');
        loadDeckList(); // Fallback
      }
    });
  }
</script>