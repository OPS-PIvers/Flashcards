<script>
  /**
   * Dictionary integration UI functionality
   */
  
  // Initialize dictionary lookup
  function initDictionaryLookup() {
    // Add event listener to lookup button
    const lookupBtn = document.getElementById('lookupWordBtn');
    if (lookupBtn) {
      lookupBtn.addEventListener('click', lookupWord);
    }
    
    // Add event listener to word input for Enter key
    const wordInput = document.getElementById('dictionaryWord');
    if (wordInput) {
      wordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          lookupWord();
        }
      });
    }
    
    // Populate deck dropdown
    populateDeckDropdown();
    
    // Add event listener to deck dropdown
    const deckDropdown = document.getElementById('targetDeck');
    if (deckDropdown) {
      deckDropdown.addEventListener('change', loadCardsForDeck);
    }
    
    // Add event listener to add to deck button
    const addToDeckBtn = document.getElementById('addToDeckBtn');
    if (addToDeckBtn) {
      addToDeckBtn.addEventListener('click', addContentToCard);
    }
  }
  
  /**
   * Look up a word in the dictionary
   */
  function lookupWord() {
    const wordInput = document.getElementById('dictionaryWord');
    const word = wordInput.value.trim();
    
    if (!word) {
      showError('Please enter a word to look up');
      return;
    }
    
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(displayDictionaryResults)
      .withFailureHandler(handleError)
      .previewDictionaryContent(word);
  }
  
  /**
   * Display dictionary lookup results
   * 
   * @param {Object} result - Dictionary lookup result
   */
  function displayDictionaryResults(result) {
    hideLoadingIndicator();
    
    if (!result.success) {
      showError(result.message);
      return;
    }
    
    // Show results area
    const resultsArea = document.getElementById('dictionaryResults');
    resultsArea.style.display = 'block';
    
    // Set word
    document.getElementById('resultWord').textContent = result.word;
    
    // Display pronunciation
    const pronunciationArea = document.getElementById('pronunciationResult');
    if (result.audioUrl) {
      pronunciationArea.innerHTML = `
        <audio controls>
          <source src="${result.audioUrl}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
      `;
    } else {
      pronunciationArea.innerHTML = '<p>No pronunciation available</p>';
    }
    
    // Display illustration
    const illustrationArea = document.getElementById('illustrationResult');
    if (result.imageUrl) {
      illustrationArea.innerHTML = `
        <img src="${result.imageUrl}" alt="Illustration of ${result.word}" style="max-width: 100%; height: auto;">
      `;
    } else {
      illustrationArea.innerHTML = '<p>No illustration available</p>';
    }
    
    // Store word data for later use
    window.currentDictionaryWord = result.word;
  }
  
  /**
   * Populate the deck dropdown
   */
  function populateDeckDropdown() {
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        
        if (!result.success) {
          showError(result.message);
          return;
        }
        
        const deckDropdown = document.getElementById('targetDeck');
        deckDropdown.innerHTML = '<option value="">Select a deck...</option>';
        
        // Filter out system sheets
        const systemSheets = ['Config', 'Classes'];
        const userDecks = result.decks.filter(deck => !systemSheets.includes(deck));
        
        userDecks.forEach(deckName => {
          const option = document.createElement('option');
          option.value = deckName;
          option.textContent = deckName;
          deckDropdown.appendChild(option);
        });
      })
      .withFailureHandler(handleError)
      .getAvailableDecks(false);
  }
  
  /**
   * Load cards for the selected deck
   */
  function loadCardsForDeck() {
    const deckDropdown = document.getElementById('targetDeck');
    const selectedDeck = deckDropdown.value;
    
    if (!selectedDeck) {
      document.getElementById('cardSelectionArea').style.display = 'none';
      return;
    }
    
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        
        if (!result.success) {
          showError(result.message);
          return;
        }
        
        const cardDropdown = document.getElementById('targetCard');
        cardDropdown.innerHTML = '<option value="">Select a card...</option>';
        
        result.cards.forEach(card => {
          const option = document.createElement('option');
          option.value = card.id;
          option.textContent = card.sideA;
          cardDropdown.appendChild(option);
        });
        
        document.getElementById('cardSelectionArea').style.display = 'block';
      })
      .withFailureHandler(handleError)
      .getFlashcardsForDeck(selectedDeck);
  }
  
  /**
   * Add dictionary content to the selected card
   */
  function addContentToCard() {
    const deckDropdown = document.getElementById('targetDeck');
    const cardDropdown = document.getElementById('targetCard');
    
    const selectedDeck = deckDropdown.value;
    const selectedCard = cardDropdown.value;
    const word = window.currentDictionaryWord;
    
    if (!selectedDeck) {
      showError('Please select a deck');
      return;
    }
    
    if (!selectedCard) {
      showError('Please select a card');
      return;
    }
    
    if (!word) {
      showError('No word data available');
      return;
    }
    
    showLoadingIndicator();
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingIndicator();
        
        if (result.success) {
          showSuccess('Dictionary content added to card');
        } else {
          showError(result.message);
        }
      })
      .withFailureHandler(handleError)
      .addDictionaryContentToCard(selectedDeck, selectedCard, word);
  }
</script>